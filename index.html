<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zakazivanje Termina</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&Sacramento&display=swap" rel="stylesheet">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>游눈</text></svg>" />
  <style>
    select:invalid {
      color: gray;
    }
    option[disabled][hidden] {
      display: none;
    }
    .tooltip {
      position: relative;
    }
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 140px;
      background-color: #ef4444;
      color: white;
      text-align: center;
      border-radius: 4px;
      padding: 4px 8px;
      position: absolute;
      z-index: 10;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.75rem;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .tooltip.invalid .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    @media (max-width: 640px) {
      .tooltip .tooltip-text {
        width: 120px;
        font-size: 0.7rem;
      }
    }
    .logo-container {
      position: relative;
      background: linear-gradient(to bottom right, #f9e4e4, #d8c3c3, #ff69b4);
      border-radius: 1rem 1rem 0 0;
      overflow: hidden;
    }
    .logo-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        linear-gradient(45deg, transparent, rgba(255, 20, 147, 0.2)),
        linear-gradient(-45deg, transparent, rgba(255, 105, 180, 0.2));
      clip-path: polygon(0 0, 50% 20%, 100% 0, 80% 50%, 100% 100%, 50% 80%, 0 100%, 20% 50%);
      z-index: 0;
    }
    .logo-container img {
      position: relative;
      z-index: 1;
    }
    .form-container {
      position: relative;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(8px);
    }
    .form-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        linear-gradient(30deg, transparent, rgba(199, 21, 133, 0.1)),
        linear-gradient(-30deg, transparent, rgba(255, 20, 147, 0.1));
      clip-path: polygon(0 0, 30% 10%, 60% 0, 70% 40%, 100% 30%, 90% 70%, 100% 100%, 40% 90%, 0 100%, 10% 60%);
      z-index: -1;
    }
    h1 {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-[#f2eaea] to-[#e2d3d3] min-h-screen flex items-center justify-center p-4">
  <div class="form-container rounded-2xl shadow-lg w-full max-w-md">
    <div class="logo-container flex justify-center py-6">
      <img src="https://i.imgur.com/0sKGZVj.png" alt="Logo" class="h-48 opacity-80 drop-shadow-lg">
    </div>
    <div class="p-6">
      <h1 class="text-2xl sm:text-3xl font-light text-[#ff69b4] mb-6 text-center" style="font-family: 'Great Vibes', 'Sacramento', Arial, sans-serif; text-shadow: 0 0 8px rgba(255, 105, 180, 0.5);">Zakazivanje Termina</h1>
      <form id="appointmentForm" class="space-y-4 text-gray-800">
        <div>
          <label for="name_lastname" class="block mb-1 text-sm font-medium">Ime i prezime</label>
          <input type="text" id="name_lastname" name="name_lastname" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400" required />
        </div>
        <div>
          <label for="phone" class="block mb-1 text-sm font-medium">Broj telefona</label>
          <input type="tel" id="phone" name="phone" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400" required pattern="\+?\d{9,15}" />
        </div>
        <div class="tooltip">
          <label for="main_service" class="block mb-1 text-sm font-medium">Usluga</label>
          <select id="main_service" name="main_service" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400" required>
            <option value="" disabled selected hidden>Izaberite uslugu</option>
            <option value="Novi set noktiju">Novi set noktiju</option>
            <option value="Korekcija">Korekcija</option>
          </select>
          <span class="tooltip-text">Molimo popunite polje</span>
        </div>
        <div id="noviSetOptions" class="hidden space-y-4">
          <div class="tooltip">
            <label for="sub_service" class="block mb-1 text-sm font-medium">Vrsta rada</label>
            <select id="sub_service" name="sub_service" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400">
              <option value="" disabled selected hidden>Izaberite vrstu</option>
              <option value="Izlivanje noktiju 코ablonima">Izlivanje noktiju 코ablonima</option>
              <option value="Izlivanje noktiju gornjim tipsama">Izlivanje noktiju gornjim tipsama</option>
              <option value="Nadogradnja noktiju">Nadogradnja noktiju</option>
            </select>
            <span class="tooltip-text">Molimo popunite polje</span>
          </div>
          <div class="tooltip">
            <label for="length" class="block mb-1 text-sm font-medium">Du쬴na noktiju</label>
            <select id="length" name="length" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400">
              <option value="" disabled selected hidden>Izaberite du쬴nu</option>
              <option value="Kratki">Kratki</option>
              <option value="Srednji">Srednji</option>
              <option value="Dugi">Dugi</option>
            </select>
            <span class="tooltip-text">Molimo popunite polje</span>
          </div>
          <div class="tooltip">
            <label for="shape" class="block mb-1 text-sm font-medium">Oblik noktiju</label>
            <select id="shape" name="shape" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400">
              <option value="" disabled selected hidden>Izaberite oblik</option>
              <option value="Kocka">Kocka</option>
              <option value="Uska kocka">Uska kocka</option>
              <option value="Badem">Badem</option>
              <option value="맗icasti">맗icasti</option>
              <option value="Ovalni">Ovalni</option>
              <option value="Drugo">Drugo</option>
            </select>
            <span class="tooltip-text">Molimo popunite polje</span>
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium">Dizajn noktiju</label>
            <div class="flex flex-col gap-1">
              <label class="flex items-center space-x-2 text-sm">
                <input type="checkbox" id="design_boja" value="Boja" class="rounded text-pink-600 focus:ring-pink-400" />
                <span>Boja</span>
              </label>
              <label class="flex items-center space-x-2 text-sm">
                <input type="checkbox" id="design_french" value="French" class="rounded text-pink-600 focus:ring-pink-400" />
                <span>French</span>
              </label>
              <label class="flex items-center space-x-2 text-sm">
                <input type="checkbox" id="design_ostalo" value="Ostalo" class="rounded text-pink-600 focus:ring-pink-400" />
                <span>Ostalo (Crtanje, Nakit, 3D, Cat-eye)</span>
              </label>
            </div>
          </div>
        </div>
        <div class="tooltip">
          <label for="date" class="block mb-1 text-sm font-medium">Dan termina</label>
          <select id="date" name="date" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400" required>
            <option value="" disabled selected hidden>Izaberite dan</option>
          </select>
          <span class="tooltip-text">Molimo popunite polje</span>
        </div>
        <div class="tooltip">
          <label for="time" class="block mb-1 text-sm font-medium">Vreme termina</label>
          <select id="time" name="time" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400" required>
            <option value="" disabled selected hidden>Izaberite vreme</option>
            </select>
          <span class="tooltip-text">Molimo popunite polje</span>
        </div>
        <div>
          <label for="notes" class="block mb-1 text-sm font-medium">Napomene</label>
          <textarea id="notes" name="notes" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400 resize-none" rows="3"></textarea>
        </div>
        <div class="text-center text-sm text-gray-600 font-medium">
          <div id="durationDisplay">Procena trajanja: -</div>
          <div id="priceDisplay">Okvirna cena rada: -</div>
        </div>
        <button type="submit" class="w-full bg-pink-600 text-white py-2 px-4 rounded-lg font-semibold text-sm hover:bg-pink-700 transition duration-200" id="submitButton">
          Zaka쬴
        </button>
      </form>
      <div id="message" class="mt-4 text-center text-sm font-semibold"></div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    window.onload = async () => {
      if (typeof supabase === 'undefined') {
        document.getElementById('message').textContent = 'Gre코ka: Supabase JS nije u캜itan.';
        document.getElementById('message').classList.add('text-red-600');
        return;
      }
      const SUPABASE_URL = 'https://xkljqcxonrnstuivtihc.supabase.co';
      let SUPABASE_ANON_KEY = localStorage.getItem('supabase_anon_key');
      if (!SUPABASE_ANON_KEY) {
        SUPABASE_ANON_KEY = prompt('Unesite Supabase anon klju캜:');
        if (SUPABASE_ANON_KEY && SUPABASE_ANON_KEY.length > 20) {
          localStorage.setItem('supabase_anon_key', SUPABASE_ANON_KEY);
        }
      }
      if (!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.length < 20) {
        document.getElementById('message').textContent = 'Va쬰캖i Supabase anon klju캜 je neophodan za nastavak.';
        document.getElementById('message').classList.add('text-red-600');
        return;
      }
      console.log('Supabase client initializing with key length:', SUPABASE_ANON_KEY.length);
      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const APPOINTMENTS_TABLE = 'appointments';
      const TIME_SLOTS = [
        '06:00', '06:30', '07:00', '07:30', '08:00', '08:30', '09:00', '09:30',
        '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00', '13:30',
        '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30',
        '18:00', '18:30', '19:00', '19:30', '20:00', '20:30', '21:00', '21:30',
        '22:00', '22:30', '23:00', '23:30', '00:00', '00:30'
      ];
      const SERVICE_CONFIG = {
        'Novi set noktiju': {
          baseDuration: 60,
          basePrice: 3000,
          requiresNoviSetOptions: true,
          additionalFields: ['sub_service', 'length', 'shape', 'design']
        },
        'Korekcija': {
          baseDuration: 30,
          basePrice: 2000,
          requiresNoviSetOptions: false,
          additionalFields: []
        }
      };
      const mainService = document.getElementById('main_service');
      const noviSetOptions = document.getElementById('noviSetOptions');
      const dateSelect = document.getElementById('date');
      const timeSelect = document.getElementById('time');
      const durationDisplay = document.getElementById('durationDisplay');
      const priceDisplay = document.getElementById('priceDisplay');
      const messageDiv = document.getElementById('message');
      const form = document.getElementById('appointmentForm');
      const subService = document.getElementById('sub_service');
      const lengthSelect = document.getElementById('length');
      const shapeSelect = document.getElementById('shape');
      function updateRequiredFields() {
        const service = mainService.value;
        const config = SERVICE_CONFIG[service] || { requiresNoviSetOptions: false, additionalFields: [] };
        const fields = ['sub_service', 'length', 'shape'];
        fields.forEach(field => {
          const element = document.getElementById(field);
          element.required = config.requiresNoviSetOptions && config.additionalFields.includes(field);
        });
      }
      mainService.addEventListener('change', () => {
        const service = mainService.value;
        const config = SERVICE_CONFIG[service] || { requiresNoviSetOptions: false };
        noviSetOptions.classList.toggle('hidden', !config.requiresNoviSetOptions);
        updateRequiredFields();
        if (!config.requiresNoviSetOptions) {
          subService.value = '';
          lengthSelect.value = '';
          shapeSelect.value = '';
          document.querySelectorAll('#noviSetOptions input[type=checkbox]').forEach(cb => cb.checked = false);
        }
        calculateEstimates();
        loadAvailableTimes();
      });
      document.querySelectorAll('#noviSetOptions select, #noviSetOptions input[type=checkbox]').forEach(el => {
        el.addEventListener('change', () => {
          calculateEstimates();
          loadAvailableTimes();
        });
      });
      dateSelect.addEventListener('change', loadAvailableTimes);
      const dropdowns = form.querySelectorAll('select');
      dropdowns.forEach(select => {
        select.addEventListener('change', () => {
          const tooltip = select.closest('.tooltip');
          if (tooltip) {
            tooltip.classList.remove('invalid');
          }
        });
      });
      function calculateEstimates() {
        const service = mainService.value;
        const config = SERVICE_CONFIG[service] || { baseDuration: 30, basePrice: 2000 };
        let duration = config.baseDuration;
        let price = config.basePrice;
        if (config.requiresNoviSetOptions) {
          const length = lengthSelect.value;
          const ostalo = document.getElementById('design_ostalo').checked;
          if (length === 'Srednji' || length === 'Dugi') {
            duration += 30;
            price += 500;
          }
          if (ostalo) {
            duration += 30;
            price += 1000;
          }
        }
        durationDisplay.textContent = `Procena trajanja: ${duration} min`;
        priceDisplay.textContent = `Okvirna cena rada: ${price} RSD`;
        return duration;
      }
      function timeToMinutes(time) {
        const [hours, minutes] = time.split(':').map(Number);
        return hours * 60 + minutes;
      }
      function minutesToTime(minutes) {
        const hours = Math.floor(minutes / 60).toString().padStart(2, '0');
        const mins = (minutes % 60).toString().padStart(2, '0');
        return `${hours}:${mins}`;
      }
      async function loadAvailableDates() {
        const { data, error } = await supabaseClient
          .from(APPOINTMENTS_TABLE)
          .select('date')
          .eq('available', true)
          .gte('date', '2025-05-24')
          .lte('date', '2026-05-24')
          .order('date', { ascending: true });
        if (error) {
          messageDiv.textContent = `Gre코ka pri u캜itavanju datuma: ${error.message}`;
          messageDiv.classList.add('text-red-600');
          console.error('Load dates error:', error);
          return;
        }
        dateSelect.innerHTML = '<option value="" disabled selected hidden>Izaberite dan</option>';
        const uniqueDates = [...new Set(data.map(d => d.date))];
        uniqueDates.forEach(date => {
          const option = document.createElement('option');
          option.value = date;
          option.textContent = new Date(date).toLocaleDateString('sr-RS', {
            weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
          });
          dateSelect.appendChild(option);
        });
        console.log('Loaded dates:', uniqueDates);
      }
      async function loadAvailableTimes() {
        const selectedDate = dateSelect.value;
        const duration = calculateEstimates();
        if (!selectedDate || !duration) {
          timeSelect.innerHTML = '<option value="" disabled selected hidden>Izaberite vreme</option>';
          return;
        }
        const { data, error } = await supabaseClient
          .from(APPOINTMENTS_TABLE)
          .select('time')
          .eq('date', selectedDate)
          .eq('available', true)
          .eq('is_booked', false)
          .order('time', { ascending: true });
        if (error) {
          messageDiv.textContent = `Gre코ka pri u캜itavanju vremena: ${error.message}`;
          messageDiv.classList.add('text-red-600');
          console.error('Load times error:', error);
          return;
        }
        const times = data.map(d => d.time.slice(0, 5));
        const validTimes = times.filter(startTime => {
          const startMinutes = timeToMinutes(startTime);
          const numSlots = Math.ceil(duration / 30);
          for (let i = 0; i < numSlots; i++) {
            const checkTime = minutesToTime(startMinutes + i * 30);
            if (!times.includes(checkTime)) {
              return false;
            }
          }
          return true;
        });
        timeSelect.innerHTML = '<option value="" disabled selected hidden>Izaberite vreme</option>';
        validTimes.forEach(time => {
          const option = document.createElement('option');
          option.value = time;
          option.textContent = time;
          timeSelect.appendChild(option);
        });
        console.log('Loaded times for', selectedDate, 'with duration', duration, ':', validTimes);
      }
      form.addEventListener('submit', async e => {
        e.preventDefault();
        const submitButton = document.getElementById('submitButton');
        submitButton.disabled = true;
        let isValid = true;
        const dropdowns = form.querySelectorAll('select:not([style*="display: none"]):not([style*="visibility: hidden"])');
        dropdowns.forEach(select => {
          if (select.required && !select.value) {
            const tooltip = select.closest('.tooltip');
            if (tooltip) {
              tooltip.classList.add('invalid');
              isValid = false;
            }
          } else {
            const tooltip = select.closest('.tooltip');
            if (tooltip) {
              tooltip.classList.remove('invalid');
            }
          }
        });
        if (!isValid) {
          messageDiv.textContent = 'Molimo popunite sva obavezna polja.';
          messageDiv.classList.add('text-red-600');
          messageDiv.classList.remove('text-green-600');
          submitButton.disabled = false;
          return;
        }
        const designOptions = [];
        if (document.getElementById('design_boja').checked) designOptions.push('Boja');
        if (document.getElementById('design_french').checked) designOptions.push('French');
        if (document.getElementById('design_ostalo').checked) designOptions.push('Ostalo');
        const duration = calculateEstimates();
        const startTime = timeSelect.value;
        const selectedDate = dateSelect.value;
        const startMinutes = timeToMinutes(startTime);
        const numSlots = Math.ceil(duration / 30);
        const slotTimes = [];
        for (let i = 0; i < numSlots; i++) {
          const slotTime = minutesToTime(startMinutes + i * 30);
          if (TIME_SLOTS.includes(slotTime)) {
            slotTimes.push(`${slotTime}:00`);
          }
        }
        console.log('Checking slot availability:', { date: selectedDate, times: slotTimes });
        const { data: slotCheck, error: checkError } = await supabaseClient
          .from(APPOINTMENTS_TABLE)
          .select('time, available, is_booked')
          .eq('date', selectedDate)
          .in('time', slotTimes);
        if (checkError) {
          messageDiv.textContent = `Gre코ka pri proveri termina: ${checkError.message}`;
          messageDiv.classList.add('text-red-600');
          messageDiv.classList.remove('text-green-600');
          console.error('Slot check error:', checkError);
          submitButton.disabled = false;
          return;
        }
        const unavailableSlots = slotCheck.filter(slot => !slot.available || slot.is_booked);
        if (unavailableSlots.length > 0) {
          messageDiv.textContent = 'Izabrani termin vi코e nije dostupan. Molimo izaberite drugo vreme.';
          messageDiv.classList.add('text-red-600');
          messageDiv.classList.remove('text-green-600');
          console.log('Unavailable slots:', unavailableSlots);
          await loadAvailableDates();
          await loadAvailableTimes();
          submitButton.disabled = false;
          return;
        }
        const payloads = slotTimes.map(slotTime => ({
          date: selectedDate,
          time: slotTime,
          is_booked: true,
          available: false,
          name_lastname: document.getElementById('name_lastname').value,
          phone: document.getElementById('phone').value,
          main_service: mainService.value,
          sub_service: subService.value || null,
          length: lengthSelect.value || null,
          shape: shapeSelect.value || null,
          design: designOptions.length ? designOptions.join(', ') : null,
          notes: document.getElementById('notes').value || null,
          duration
        }));
        console.log('Upsert payload:', payloads);
        try {
          const { data, error } = await supabaseClient
            .from(APPOINTMENTS_TABLE)
            .upsert(payloads, {
              onConflict: ['date', 'time'],
              ignoreDuplicates: false
            })
            .select();
          if (error) {
            messageDiv.textContent = `Gre코ka pri zakazivanju: ${error.message}. Proverite RLS politike.`;
            messageDiv.classList.add('text-red-600');
            messageDiv.classList.remove('text-green-600');
            console.error('Upsert error:', error);
          } else {
            messageDiv.textContent = 'Uspe코no ste zakazali termin!';
            messageDiv.classList.add('text-green-600');
            messageDiv.classList.remove('text-red-600');
            form.reset();
            noviSetOptions.classList.add('hidden');
            durationDisplay.textContent = 'Procena trajanja: -';
            priceDisplay.textContent = 'Okvirna cena rada: -';
            dateSelect.innerHTML = '<option value="" disabled selected hidden>Izaberite dan</option>';
            timeSelect.innerHTML = '<option value="" disabled selected hidden>Izaberite vreme</option>';
            document.querySelectorAll('.tooltip').forEach(tooltip => tooltip.classList.remove('invalid'));
            updateRequiredFields();
            await loadAvailableDates();
          }
        } catch (err) {
          messageDiv.textContent = 'Neo캜ekivana gre코ka. Proverite konzolu.';
          messageDiv.classList.add('text-red-600');
          console.error('Unexpected error:', err);
        } finally {
          submitButton.disabled = false;
        }
      });
      updateRequiredFields();
      await loadAvailableDates();
    };
  </script>
</body>
</html>
