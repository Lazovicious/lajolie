<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rezervacija Termina - La Jolie</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px auto;
      max-width: 600px;
      padding: 0 10px;
      background-color: #f5f5f5;
      color: #333;
    }
    h1 {
      font-size: 1.5rem;
      text-align: center;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      font-size: 1rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    button {
      display: block;
      width: 100%;
      padding: 10px;
      font-size: 1rem;
      background-color: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    button:disabled {
      background-color: #90caf9;
      cursor: not-allowed;
    }
    .message {
      text-align: center;
      padding: 10px;
      font-size: 1rem;
      color: #2e7d32;
      display: none;
    }
    .message.error {
      color: #c62828;
    }
    .message.visible {
      display: block;
    }
  </style>
</head>
<body>
  <h1>Rezervacija Termina - La Jolie</h1>
  <form id="bookingForm">
    <div class="form-group">
      <label for="name_lastname">Ime i Prezime *</label>
      <input type="text" id="name_lastname" required />
    </div>
    <div class="form-group">
      <label for="phone">Telefon *</label>
      <input type="tel" id="phone" required />
    </div>
    <div class="form-group">
      <label for="main_service">Usluga *</label>
      <select id="main_service" required>
        <option value="">Izaberite uslugu</option>
        <option value="Manikir">Manikir</option>
        <option value="Pedikir">Pedikir</option>
        <option value="Depilacija">Depilacija</option>
      </select>
    </div>
    <div class="form-group">
      <label for="sub_service">Specifična Usluga *</label>
      <select id="sub_service" required>
        <option value="">Prvo izaberite uslugu</option>
      </select>
    </div>
    <div class="form-group">
      <label for="length">Dužina Noktiju</label>
      <select id="length">
        <option value="">Izaberite dužinu</option>
        <option value="Kratki">Kratki</option>
        <option value="Srednji">Srednji</option>
        <option value="Dugi">Dugi</option>
      </select>
    </div>
    <div class="form-group">
      <label for="shape">Oblik Noktiju</label>
      <select id="shape">
        <option value="">Izaberite oblik</option>
        <option value="Kvadratni">Kvadratni</option>
        <option value="Badem">Badem</option>
        <option value="Ovalni">Ovalni</option>
        <option value="Stiletto">Stiletto</option>
      </select>
    </div>
    <div class="form-group">
      <label for="design">Dizajn</label>
      <select id="design">
        <option value="">Izaberite dizajn</option>
        <option value="Bez dizajna">Bez dizajna</option>
        <option value="French">French</option>
        <option value="Ombre">Ombre</option>
        <option value="Dekoracija">Dekoracija</option>
      </select>
    </div>
    <div class="form-group">
      <label for="date">Datum *</label>
      <select id="date" required>
        <option value="">Izaberite datum</option>
      </select>
    </div>
    <div class="form-group">
      <label for="time">Vreme *</label>
      <select id="time" required>
        <option value="">Izaberite vreme</option>
      </select>
    </div>
    <div class="form-group">
      <label for="notes">Napomene</label>
      <textarea id="notes"></textarea>
    </div>
    <button type="submit" id="submitButton" disabled>Rezerviši</button>
  </form>
  <div id="message" class="message"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    const SUPABASE_URL = 'https://xkljqcxonrnstuivtihc.supabase.co';
    const SUPABASE_ANON_KEY = 'your-anon-key-here'; // Replace with your anon key
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const APPOINTMENTS_TABLE = 'appointments';

    const SERVICE_DURATIONS = {
      'Gel lak': 60,
      'Izlivanje noktiju': 90,
      'Korekcija noktiju': 75,
      'Estetski pedikir': 45,
      'Medicinski pedikir': 60,
      'Depilacija celih nogu': 30,
      'Depilacija pola nogu': 20,
      'Depilacija ruku': 15,
      'Depilacija pazuha': 10,
      'Depilacija nausnica': 10
    };

    const SUB_SERVICES = {
      'Manikir': ['Gel lak', 'Izlivanje noktiju', 'Korekcija noktiju'],
      'Pedikir': ['Estetski pedikir', 'Medicinski pedikir'],
      'Depilacija': ['Depilacija celih nogu', 'Depilacija pola nogu', 'Depilacija ruku', 'Depilacija pazuha', 'Depilacija nausnica']
    };

    function showMessage(text, isError = false) {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = text;
      messageDiv.classList.toggle('error', isError);
      messageDiv.classList.add('visible');
      setTimeout(() => messageDiv.classList.remove('visible'), 3000);
    }

    function formatDate(d) {
      return d.toISOString().slice(0, 10);
    }

    function formatDisplayDate(d) {
      return d.toLocaleDateString('sr-RS', { weekday: 'short', day: 'numeric', month: 'short' });
    }

    function timeToMinutes(time) {
      const [hours, minutes] = time.split(':').map(Number);
      return hours * 60 + minutes;
    }

    async function loadAvailableDates() {
      const { data, error } = await supabaseClient
        .from(APPOINTMENTS_TABLE)
        .select('date')
        .eq('available', true)
        .eq('is_booked', false)
        .gte('date', formatDate(new Date()))
        .order('date', { ascending: true });

      if (error) {
        console.error('Error loading dates:', error);
        showMessage(`Greška pri učitavanju datuma: ${error.message}`, true);
        return [];
      }

      const uniqueDates = [...new Set(data.map(d => d.date.split('T')[0]))];
      const dateSelect = document.getElementById('date');
      dateSelect.innerHTML = '<option value="">Izaberite datum</option>';
      uniqueDates.forEach(date => {
        const d = new Date(date);
        const option = document.createElement('option');
        option.value = date;
        option.textContent = formatDisplayDate(d);
        dateSelect.appendChild(option);
      });

      return uniqueDates;
    }

    async function loadAvailableTimes(selectedDate, duration) {
      if (!selectedDate || !duration) return;

      const { data, error } = await supabaseClient
        .from(APPOINTMENTS_TABLE)
        .select('date, time, available, is_booked')
        .eq('date', selectedDate)
        .order('time', { ascending: true });

      if (error) {
        console.error('Error loading times:', error);
        showMessage(`Greška pri učitavanju vremena: ${error.message}`, true);
        return;
      }

      const timeSelect = document.getElementById('time');
      timeSelect.innerHTML = '<option value="">Izaberite vreme</option>';

      // Filter times where all slots in duration are available
      const availableTimes = [];
      data.forEach(row => {
        if (!row.available || row.is_booked) return;
        const startMinutes = timeToMinutes(row.time);
        const numSlots = Math.ceil(duration / 30);
        let allAvailable = true;
        for (let i = 0; i < numSlots; i++) {
          const slotTime = minutesToTime(startMinutes + i * 30);
          const slot = data.find(d => d.time === slotTime);
          if (!slot || !slot.available || slot.is_booked) {
            allAvailable = false;
            break;
          }
        }
        if (allAvailable) {
          availableTimes.push(row.time);
        }
      });

      availableTimes.sort().forEach(time => {
        const option = document.createElement('option');
        option.value = time;
        option.textContent = time.slice(0, 5); // Display HH:MM
        timeSelect.appendChild(option);
      });

      timeSelect.disabled = availableTimes.length === 0;
      document.getElementById('submitButton').disabled = availableTimes.length === 0;
    }

    function minutesToTime(minutes) {
      const hours = Math.floor(minutes / 60).toString().padStart(2, '0');
      const mins = (minutes % 60).toString().padStart(2, '0');
      return `${hours}:${mins}:00`;
    }

    async function submitForm(event) {
      event.preventDefault();
      const submitButton = document.getElementById('submitButton');
      submitButton.disabled = true;

      const formData = {
        name_lastname: document.getElementById('name_lastname').value,
        phone: document.getElementById('phone').value,
        main_service: document.getElementById('main_service').value,
        sub_service: document.getElementById('sub_service').value,
        length: document.getElementById('length').value || null,
        shape: document.getElementById('shape').value || null,
        design: document.getElementById('design').value || null,
        date: document.getElementById('date').value,
        time: document.getElementById('time').value,
        notes: document.getElementById('notes').value || null,
        duration: SERVICE_DURATIONS[document.getElementById('sub_service').value] || 30,
        is_booked: true,
        available: false
      };

      // Validate duration
      const startMinutes = timeToMinutes(formData.time);
      const numSlots = Math.ceil(formData.duration / 30);
      const slotsToUpdate = [];
      for (let i = 0; i < numSlots; i++) {
        const slotTime = minutesToTime(startMinutes + i * 30);
        slotsToUpdate.push({
          date: formData.date,
          time: slotTime,
          is_booked: true,
          available: false,
          name_lastname: formData.name_lastname,
          phone: formData.phone,
          main_service: formData.main_service,
          sub_service: formData.sub_service,
          length: formData.length,
          shape: formData.shape,
          design: formData.design,
          notes: formData.notes,
          duration: formData.duration
        });
      }

      try {
        const { data, error } = await supabaseClient
          .from(APPOINTMENTS_TABLE)
          .upsert(slotsToUpdate, {
            onConflict: ['date', 'time'],
            ignoreDuplicates: false
          })
          .select();

        if (error) {
          console.error('Upsert error:', error);
          showMessage(`Greška pri rezervaciji: ${error.message}`, true);
        } else {
          console.log('Upsert response:', data);
          showMessage('Rezervacija uspešna!');
          document.getElementById('bookingForm').reset();
          document.getElementById('date').innerHTML = '<option value="">Izaberite datum</option>';
          document.getElementById('time').innerHTML = '<option value="">Izaberite vreme</option>';
          document.getElementById('sub_service').innerHTML = '<option value="">Prvo izaberite uslugu</option>';
          await loadAvailableDates();
        }
      } catch (err) {
        console.error('Unexpected error:', err);
        showMessage('Neočekivana greška. Proverite konzolu.', true);
      } finally {
        submitButton.disabled = false;
      }
    }

    // Event Listeners
    document.getElementById('main_service').addEventListener('change', (e) => {
      const subServiceSelect = document.getElementById('sub_service');
      subServiceSelect.innerHTML = '<option value="">Izaberite specifičnu uslugu</option>';
      const subs = SUB_SERVICES[e.target.value] || [];
      subs.forEach(sub => {
        const option = document.createElement('option');
        option.value = sub;
        option.textContent = sub;
        subServiceSelect.appendChild(option);
      });
      subServiceSelect.disabled = subs.length === 0;
    });

    document.getElementById('sub_service').addEventListener('change', async () => {
      const date = document.getElementById('date').value;
      const subService = document.getElementById('sub_service').value;
      const duration = SERVICE_DURATIONS[subService] || 30;
      if (date) {
        await loadAvailableTimes(date, duration);
      }
    });

    document.getElementById('date').addEventListener('change', async (e) => {
      const subService = document.getElementById('sub_service').value;
      const duration = SERVICE_DURATIONS[subService] || 30;
      await loadAvailableTimes(e.target.value, duration);
    });

    document.getElementById('bookingForm').addEventListener('submit', submitForm);

    // Initialize
    loadAvailableDates();
  </script>
</body>
</html>
