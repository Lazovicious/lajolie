<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zakazivanje Termina</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    select:invalid {
      color: gray;
    }
    option[disabled][hidden] {
      display: none;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-[#f2eaea] to-[#e2d3d3] min-h-screen flex items-center justify-center p-4">
  <div class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg w-full max-w-md">
    <div class="flex justify-center py-4">
      <img src="https://i.imgur.com/0sKGZVj.png" alt="Logo" class="h-32">
    </div>
    <div class="p-6">
      <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">Zakazivanje Termina</h1>
      <form id="appointmentForm" class="space-y-4 text-gray-800">
        <div>
          <label for="imePrezime" class="block mb-1 text-sm font-medium">Ime i prezime</label>
          <input type="text" id="imePrezime" name="imePrezime" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400" required />
        </div>

        <div>
          <label for="telefon" class="block mb-1 text-sm font-medium">Broj telefona</label>
          <input type="tel" id="telefon" name="telefon" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400" required pattern="\+?\d{9,15}" />
        </div>

        <div>
          <label for="mainService" class="block mb-1 text-sm font-medium">Usluga</label>
          <select id="mainService" name="mainService" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400" required>
            <option value="" disabled selected hidden>Izaberite uslugu</option>
            <option value="noviSet">Novi set noktiju</option>
            <option value="korekcija">Korekcija</option>
          </select>
        </div>

        <div id="noviSetOptions" class="hidden space-y-4">
          <div>
            <label for="noviSetType" class="block mb-1 text-sm font-medium">Vrsta rada</label>
            <select id="noviSetType" name="noviSetType" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400">
              <option value="" disabled selected hidden>Izaberite vrstu</option>
              <option value="sabloni">Izlivanje noktiju šablonima</option>
              <option value="tipsama">Izlivanje noktiju gornjim tipsama</option>
              <option value="nadogradnja">Nadogradnja noktiju</option>
            </select>
          </div>

          <div>
            <label for="duzina" class="block mb-1 text-sm font-medium">Dužina noktiju</label>
            <select id="duzina" name="duzina" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400">
              <option value="" disabled selected hidden>Izaberite dužinu</option>
              <option value="kratki">Kratki</option>
              <option value="srednji">Srednji</option>
              <option value="dugi">Dugi</option>
            </select>
          </div>

          <div>
            <label for="oblik" class="block mb-1 text-sm font-medium">Oblik noktiju</label>
            <select id="oblik" name="oblik" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400">
              <option value="" disabled selected hidden>Izaberite oblik</option>
              <option value="kocka">Kocka</option>
              <option value="uskaKocka">Uska kocka</option>
              <option value="badem">Badem</option>
              <option value="spicasti">Špicasti</option>
              <option value="ovalni">Ovalni</option>
              <option value="drugo">Drugo</option>
            </select>
          </div>

          <div>
            <label class="block mb-1 text-sm font-medium">Dizajn noktiju</label>
            <div class="flex flex-col gap-1">
              <label class="flex items-center space-x-2 text-sm">
                <input type="checkbox" id="boja" value="boja" class="rounded text-pink-600 focus:ring-pink-400" />
                <span>Boja</span>
              </label>
              <label class="flex items-center space-x-2 text-sm">
                <input type="checkbox" id="french" value="french" class="rounded text-pink-600 focus:ring-pink-400" />
                <span>French</span>
              </label>
              <label class="flex items-center space-x-2 text-sm">
                <input type="checkbox" id="ostalo" value="ostalo" class="rounded text-pink-600 focus:ring-pink-400" />
                <span>Ostalo (Crtanje, Nakit, 3D, Cat-eye)</span>
              </label>
            </div>
          </div>
        </div>

        <div>
          <label for="date" class="block mb-1 text-sm font-medium">Dan termina</label>
          <select id="date" name="date" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400" required>
            <option value="" disabled selected hidden>Izaberite dan</option>
          </select>
        </div>

        <div>
          <label for="time" class="block mb-1 text-sm font-medium">Vreme termina</label>
          <select id="time" name="time" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400" required>
            <option value="" disabled selected hidden>Izaberite vreme</option>
          </select>
        </div>

        <div>
          <label for="komentar" class="block mb-1 text-sm font-medium">Napomene</label>
          <textarea id="komentar" name="komentar" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-pink-400 resize-none" rows="3"></textarea>
        </div>

        <div class="text-center text-sm text-gray-600 font-medium">
          <div id="durationDisplay">Procena trajanja: -</div>
          <div id="priceDisplay">Okvirna cena rada: -</div>
        </div>

        <button type="submit" class="w-full bg-pink-600 text-white py-2 px-4 rounded-lg font-semibold text-sm hover:bg-pink-700 transition duration-200">
          Zakaži
        </button>
      </form>

      <div id="message" class="mt-4 text-center text-sm font-semibold"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    window.onload = async () => {
      if (typeof supabase === 'undefined') {
        document.getElementById('message').textContent = 'Greška: Supabase JS nije učitan.';
        document.getElementById('message').classList.add('text-red-600');
        return;
      }

      const SUPABASE_URL = 'https://xkljqcxonrnstuivtihc.supabase.co';
      const SUPABASE_ANON_KEY = prompt('Unesite Supabase anon ključ:');
      if (!SUPABASE_ANON_KEY) {
        document.getElementById('message').textContent = 'Supabase ključ je neophodan.';
        document.getElementById('message').classList.add('text-red-600');
        return;
      }

      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const TIME_SLOTS = [];
      for (let h = 8; h <= 20; h++) {
        TIME_SLOTS.push(`${h.toString().padStart(2, '0')}:00`);
        if (h < 20) TIME_SLOTS.push(`${h.toString().padStart(2, '0')}:30`);
      }

      const mainService = document.getElementById('mainService');
      const noviSetOptions = document.getElementById('noviSetOptions');
      const dateSelect = document.getElementById('date');
      const timeSelect = document.getElementById('time');
      const durationDisplay = document.getElementById('durationDisplay');
      const priceDisplay = document.getElementById('priceDisplay');
      const messageDiv = document.getElementById('message');

      mainService.addEventListener('change', () => {
        noviSetOptions.classList.toggle('hidden', mainService.value !== 'noviSet');
        calculateEstimates();
      });

      document.querySelectorAll('#noviSetOptions select, #noviSetOptions input[type=checkbox]').forEach(el => {
        el.addEventListener('change', calculateEstimates);
      });

      dateSelect.addEventListener('change', loadAvailableTimes);

      function calculateEstimates() {
        let duration = mainService.value === 'korekcija' ? 30 : 60; // 30 min for korekcija, 60 min for noviSet
        let price = mainService.value === 'korekcija' ? 2000 : 3000; // Example prices

        if (mainService.value === 'noviSet') {
          const duzina = document.getElementById('duzina').value;
          const ostalo = document.getElementById('ostalo').checked;
          if (duzina === 'srednji' || duzina === 'dugi') {
            duration += 30;
            price += 500;
          }
          if (ostalo) {
            duration += 30;
            price += 1000;
          }
        }

        durationDisplay.textContent = `Procena trajanja: ${duration} min`;
        priceDisplay.textContent = `Okvirna cena rada: ${price} RSD`;
        return duration;
      }

      async function loadAvailableDates() {
        const now = new Date();
        const dates = [];
        for (let i = 0; i < 14; i++) {
          const date = new Date(now);
          date.setDate(now.getDate() + i);
          dates.push(date.toISOString().slice(0, 10));
        }

        const { data: availabilityData, error } = await supabaseClient
          .from('availability_slots')
          .select('date, time')
          .in('date', dates)
          .eq('available', true)
          .eq('is_booked', false);

        if (error) {
          messageDiv.textContent = 'Greška pri učitavanju datuma.';
          messageDiv.classList.add('text-red-600');
          return;
        }

        const { data: bookingData } = await supabaseClient
          .from('jolie_t1')
          .select('date, time, duration')
          .in('date', dates);

        const occupiedSlots = {};
        bookingData.forEach(b => {
          const dateStr = b.date;
          if (!occupiedSlots[dateStr]) occupiedSlots[dateStr] = new Set();
          const startMinutes = parseInt(b.time.split(':')[0]) * 60 + parseInt(b.time.split(':')[1]);
          const numSlots = Math.ceil(b.duration / 30);
          for (let i = 0; i < numSlots; i++) {
            const slotTime = `${Math.floor((startMinutes + i * 30) / 60).toString().padStart(2, '0')}:${((startMinutes + i * 30) % 60).toString().padStart(2, '0')}`;
            if (TIME_SLOTS.includes(slotTime)) {
              occupiedSlots[dateStr].add(slotTime);
            }
          }
        });

        dateSelect.innerHTML = '<option value="" disabled selected hidden>Izaberite dan</option>';
        const availableDates = new Set(availabilityData.map(d => d.date).filter(d => {
          const availableTimes = availabilityData.filter(a => a.date === d).map(a => a.time);
          return availableTimes.some(t => !occupiedSlots[d]?.has(t));
        }));

        dates.forEach(date => {
          if (availableDates.has(date)) {
            const option = document.createElement('option');
            option.value = date;
            option.textContent = new Date(date).toLocaleDateString('sr-RS', { weekday: 'long', day: 'numeric', month: 'long' });
            dateSelect.appendChild(option);
          }
        });
      }

      async function loadAvailableTimes() {
        const selectedDate = dateSelect.value;
        if (!selectedDate) return;

        timeSelect.innerHTML = '<option value="" disabled selected hidden>Izaberite vreme</option>';
        const duration = calculateEstimates();

        const { data: availabilityData, error } = await supabaseClient
          .from('availability_slots')
          .select('time')
          .eq('date', selectedDate)
          .eq('available', true)
          .eq('is_booked', false);

        if (error) {
          messageDiv.textContent = 'Greška pri učitavanju vremena.';
          messageDiv.classList.add('text-red-600');
          return;
        }

        const { data: bookingData } = await supabaseClient
          .from('jolie_t1')
          .select('time, duration')
          .eq('date', selectedDate);

        const occupiedTimes = new Set();
        bookingData.forEach(b => {
          const startMinutes = parseInt(b.time.split(':')[0]) * 60 + parseInt(b.time.split(':')[1]);
          const numSlots = Math.ceil(b.duration / 30);
          for (let i = 0; i < numSlots; i++) {
            const slotTime = `${Math.floor((startMinutes + i * 30) / 60).toString().padStart(2, '0')}:${((startMinutes + i * 30) % 60).toString().padStart(2, '0')}`;
            if (TIME_SLOTS.includes(slotTime)) {
              occupiedTimes.add(slotTime);
            }
          }
        });

        const availableTimes = availabilityData.map(d => d.time).filter(t => !occupiedTimes.has(t));
        const validTimes = availableTimes.filter(startTime => {
          const startMinutes = parseInt(startTime.split(':')[0]) * 60 + parseInt(startTime.split(':')[1]);
          const numSlots = Math.ceil(duration / 30);
          for (let i = 0; i < numSlots; i++) {
            const slotTime = `${Math.floor((startMinutes + i * 30) / 60).toString().padStart(2, '0')}:${((startMinutes + i * 30) % 60).toString().padStart(2, '0')}`;
            if (!TIME_SLOTS.includes(slotTime) || occupiedTimes.has(slotTime) || !availableTimes.includes(slotTime)) {
              return false;
            }
          }
          return true;
        });

        validTimes.forEach(time => {
          const option = document.createElement('option');
          option.value = time;
          option.textContent = time;
          timeSelect.appendChild(option);
        });
      }

      document.getElementById('appointmentForm').addEventListener('submit', async e => {
        e.preventDefault();

        const designOptions = [];
        if (document.getElementById('boja').checked) designOptions.push('Boja');
        if (document.getElementById('french').checked) designOptions.push('French');
        if (document.getElementById('ostalo').checked) designOptions.push('Ostalo');

        const duration = calculateEstimates();
        const payload = {
          name_lastname: document.getElementById('imePrezime').value,
          phone: document.getElementById('telefon').value,
          main_service: document.getElementById('mainService').value,
          sub_service: document.getElementById('noviSetType').value || null,
          length: document.getElementById('duzina').value || null,
          shape: document.getElementById('oblik').value || null,
          design: designOptions.length ? designOptions : null,
          date: document.getElementById('date').value,
          time: document.getElementById('time').value,
          notes: document.getElementById('komentar').value,
          duration: duration
        };

        const { error } = await supabaseClient
          .from('jolie_t1')
          .insert([payload]);

        if (error) {
          messageDiv.textContent = 'Greška pri zakazivanju. Pokušajte ponovo.';
          messageDiv.classList.add('text-red-600');
          messageDiv.classList.remove('text-green-600');
        } else {
          messageDiv.textContent = 'Uspešno ste zakazali termin!';
          messageDiv.classList.add('text-green-600');
          messageDiv.classList.remove('text-red-600');
          document.getElementById('appointmentForm').reset();
          noviSetOptions.classList.add('hidden');
          durationDisplay.textContent = 'Procena trajanja: -';
          priceDisplay.textContent = 'Okvirna cena rada: -';
          dateSelect.innerHTML = '<option value="" disabled selected hidden>Izaberite dan</option>';
          timeSelect.innerHTML = '<option value="" disabled selected hidden>Izaberite vreme</option>';
          await loadAvailableDates();
        }
      });

      await loadAvailableDates();
    };
  </script>
</body>
</html>
