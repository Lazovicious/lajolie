<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin: Manage Available Time Slots</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 20px auto;
      padding: 0 10px;
    }
    h1 {
      text-align: center;
    }
    .calendar {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 20px;
      user-select: none;
    }
    .day-column {
      flex: 1;
      min-width: 120px;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 6px;
      display: flex;
      flex-direction: column;
    }
    .day-header {
      font-weight: bold;
      text-align: center;
      margin-bottom: 8px;
      font-size: 1.1em;
    }
    .time-slot {
      margin: 3px 0;
      padding: 5px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      text-align: center;
      background-color: #eee;
      transition: background-color 0.3s;
    }
    .time-slot.available {
      background-color: #b3e6b3;
    }
    .time-slot.occupied {
      background-color: #e68a8a;
      cursor: not-allowed;
      color: #660000;
    }
    .time-slot.selected {
      background-color: #3399ff;
      color: white;
    }
    .time-slot.unavailable {
      background-color: #ff6666;
    }
    .message {
      margin-top: 10px;
      font-weight: bold;
      text-align: center;
      color: green;
    }
  </style>
</head>
<body>
  <h1>Admin: Manage Available Time Slots</h1>
  <div id="calendar" class="calendar"></div>
  <div id="message" class="message"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    window.onload = async () => {
      if (typeof supabase === 'undefined') {
        console.error('Supabase JS not loaded.');
        alert('Greška: Supabase JS nije učitan. Osvežite stranicu.');
        return;
      }

      const SUPABASE_URL = 'https://xkljqcxonrnstuivtihc.supabase.co';
      const SUPABASE_ANON_KEY = prompt('Unesite Supabase anon ključ za admin pristup:');
      if (!SUPABASE_ANON_KEY) {
        alert('Admin ključ je neophodan. Osvežite stranicu da pokušate ponovo.');
        return;
      }

      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('Supabase initialized:', supabaseClient);

      const AVAILABILITY_TABLE = 'availability_slots';
      const BOOKINGS_TABLE = 'jolie_t1';
      const DAY_NAMES = ['Ponedeljak', 'Utorak', 'Sreda', 'Četvrtak', 'Petak', 'Subota', 'Nedelja'];

      const TIME_SLOTS = [];
      for (let h = 8; h < 20; h++) {
        TIME_SLOTS.push(h.toString().padStart(2, '0') + ':00');
        TIME_SLOTS.push(h.toString().padStart(2, '0') + ':30');
      }
      TIME_SLOTS.push('20:00');

      function getMonday(d) {
        d = new Date(d);
        const day = d.getDay();
        const diff = (day === 0 ? -6 : 1) - day;
        d.setDate(d.getDate() + diff);
        return d;
      }

      const monday = getMonday(new Date());
      const datesOfWeek = [];
      for (let i = 0; i < 7; i++) {
        const dt = new Date(monday);
        dt.setDate(monday.getDate() + i);
        datesOfWeek.push(dt);
      }

      function formatDate(d) {
        return d.toISOString().slice(0, 10);
      }

      async function loadData() {
        const { data: availabilityData, error: availabilityError } = await supabaseClient
          .from(AVAILABILITY_TABLE)
          .select('*')
          .in('date', datesOfWeek.map(formatDate));
        if (availabilityError) {
          console.error('Availability error:', availabilityError);
          alert('Greška pri učitavanju dostupnosti: ' + availabilityError.message);
          return null;
        }

        const { data: bookingData, error: bookingError } = await supabaseClient
          .from(BOOKINGS_TABLE)
          .select('date,time')
          .in('date', datesOfWeek.map(formatDate));
        if (bookingError) {
          console.error('Booking error:', bookingError);
          alert('Greška pri učitavanju rezervacija: ' + bookingError.message);
          return null;
        }

        console.log('Fetched data:', { availabilityData, bookingData });
        return { availabilityData, bookingData };
      }

      function buildAvailabilityMap(data) {
        const map = {};
        data.forEach(row => {
          if (!map[row.date]) map[row.date] = {};
          map[row.date][row.time] = row.available;
        });
        return map;
      }

      function buildBookingMap(data) {
        const map = {};
        data.forEach(b => {
          if (!map[b.date]) map[b.date] = {};
          map[b.date][b.time] = true;
        });
        return map;
      }

      const selectedSlots = new Set();

      function renderCalendar(availabilityMap, bookingMap) {
        const calendarDiv = document.getElementById('calendar');
        calendarDiv.innerHTML = '';

        for (let i = 0; i < 7; i++) {
          const dayDate = datesOfWeek[i];
          const dayStr = formatDate(dayDate);

          const dayCol = document.createElement('div');
          dayCol.className = 'day-column';

          const header = document.createElement('div');
          header.className = 'day-header';
          header.textContent = DAY_NAMES[i] + ' ' + dayStr;
          dayCol.appendChild(header);

          TIME_SLOTS.forEach(time => {
            const slot = document.createElement('div');
            slot.className = 'time-slot';
            slot.textContent = time;

            const isOccupied = bookingMap[dayStr] && bookingMap[dayStr][time];
            const isAvailable = availabilityMap[dayStr] && availabilityMap[dayStr][time];

            if (isOccupied) {
              slot.classList.add('occupied');
              slot.title = 'Zakazano (ne može se menjati)';
            } else if (isAvailable) {
              slot.classList.add('available');
            }

            if (!isOccupied) {
              slot.addEventListener('click', () => {
                const key = dayStr + '|' + time + '|true';
                if (selectedSlots.has(key)) {
                  selectedSlots.delete(key);
                  slot.classList.remove('selected');
                } else {
                  selectedSlots.add(key);
                  slot.classList.add('selected');
                }
                console.log('Selected slots:', [...selectedSlots]);
              });

              slot.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                if (isAvailable) {
                  const key = dayStr + '|' + time + '|false';
                  selectedSlots.add(key);
                  slot.classList.add('unavailable');
                  console.log('Marked unavailable:', key);
                }
              });
            }

            dayCol.appendChild(slot);
          });

          calendarDiv.appendChild(dayCol);
        }
      }

      async function saveSelectedSlots() {
        if (selectedSlots.size === 0) {
          alert('Nema izabranih termina za čuvanje.');
          return;
        }

        const slotsToSave = [];
        selectedSlots.forEach(key => {
          const [date, time, available = 'true'] = key.split('|');
          slotsToSave.push({ date, time, available: available === 'true' });
        });

        const { error } = await supabaseClient
          .from(AVAILABILITY_TABLE)
          .upsert(slotsToSave, { onConflict: ['date', 'time'] });
        console.log('Upsert response:', { error });

        if (error) {
          alert('Greška prilikom čuvanja: ' + error.message);
        } else {
          document.getElementById('message').textContent = 'Termini sačuvani!';
          selectedSlots.clear();
          const data = await loadData();
          if (data) {
            const availabilityMap = buildAvailabilityMap(data.availabilityData);
            renderCalendar(availabilityMap, buildBookingMap(data.bookingData));
          }
        }
      }

      async function main() {
        document.getElementById('message').textContent = 'Učitavanje...';
        const data = await loadData();
        if (!data) return;

        const availabilityMap = buildAvailabilityMap(data.availabilityData);
        const bookingMap = buildBookingMap(data.bookingData);
        console.log('Maps:', { availabilityMap, bookingMap });

        renderCalendar(availabilityMap, bookingMap);
        document.getElementById('message').textContent = '';
      }

      // Create buttons
      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Sačuvaj izabrane termine';
      saveBtn.style.margin = '20px 10px';
      saveBtn.style.display = 'inline-block';
      saveBtn.id = 'saveButton';
      saveBtn.onclick = saveSelectedSlots;
      document.body.appendChild(saveBtn);

      const clearBtn = document.createElement('button');
      clearBtn.textContent = 'Poništi izbor';
      clearBtn.style.margin = '20px 10px';
      clearBtn.style.display = 'inline-block';
      clearBtn.onclick = async () => { // Fixed: Added async
        selectedSlots.clear();
        const data = await loadData();
        if (data) {
          renderCalendar(buildAvailabilityMap(data.availabilityData), buildBookingMap(data.bookingData));
          document.getElementById('message').textContent = 'Izbor poništen.';
        }
      };
      document.body.appendChild(clearBtn);

      await main();
    };
  </script>
</body>
</html>
