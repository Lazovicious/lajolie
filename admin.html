<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - Upravljanje Terminima</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÖ</text></svg>" />
  <style>
    select:invalid { color: gray; }
    option[disabled][hidden] { display: none; }
    .slot-available { background-color: #d1fae5; }
    .slot-booked { background-color: #fee2e2; }
    .slot-unavailable { background-color: #e5e7eb; }
    @media (max-width: 640px) {
      table { font-size: 0.75rem; }
      th, td { padding: 0.25rem; }
      #time-column { position: sticky; left: 0; background: #f9fafb; z-index: 10; }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-[#f2eaea] to-[#e2d3d3] min-h-screen flex flex-col items-center p-4">
  <div class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg w-full max-w-4xl p-4 sm:p-6">
    <h1 class="text-xl font-bold text-gray-800 mb-4 text-center">Upravljanje Terminima</h1>
    <div class="flex justify-between items-center mb-4">
      <button id="prevWeek" class="bg-pink-600 text-white py-1 px-2 rounded-lg hover:bg-pink-700 text-sm">Prethodna</button>
      <span id="weekDisplay" class="text-base font-semibold flex-1 text-center"></span>
      <button id="nextWeek" class="bg-pink-600 text-white py-1 px-2 rounded-lg hover:bg-pink-700 text-sm">Sledeƒáa</button>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full border-collapse">
        <thead>
          <tr class="bg-gray-100">
            <th id="time-column" class="border p-1 sm:p-2 text-xs sm:text-sm">Vreme</th>
            <th id="day0" class="border p-1 sm:p-2 text-xs sm:text-sm"></th>
            <th id="day1" class="border p-1 sm:p-2 text-xs sm:text-sm"></th>
            <th id="day2" class="border p-1 sm:p-2 text-xs sm:text-sm"></th>
            <th id="day3" class="border p-1 sm:p-2 text-xs sm:text-sm"></th>
            <th id="day4" class="border p-1 sm:p-2 text-xs sm:text-sm"></th>
            <th id="day5" class="border p-1 sm:p-2 text-xs sm:text-sm"></th>
            <th id="day6" class="border p-1 sm:p-2 text-xs sm:text-sm"></th>
          </tr>
        </thead>
        <tbody id="slotsTable"></tbody>
      </table>
    </div>
    <div class="mt-4 flex justify-center">
      <button id="historyButton" class="bg-blue-600 text-white py-1 px-4 rounded-lg hover:bg-blue-700 text-sm">Istorija otkazanih termina</button>
    </div>
    <div id="message" class="mt-4 text-center text-sm font-semibold"></div>
  </div>

  <!-- Modal for booked slot details -->
  <div id="bookingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
      <h2 class="text-lg font-semibold mb-4">Detalji Rezervacije</h2>
      <div id="bookingDetails" class="space-y-2 text-sm"></div>
      <div class="flex justify-end mt-6 space-x-2">
        <button id="cancelBooking" class="bg-red-600 text-white py-1 px-3 rounded-lg hover:bg-red-700 text-sm">Otka≈æi</button>
        <button id="closeModal" class="bg-gray-600 text-white py-1 px-3 rounded-lg hover:bg-gray-700 text-sm">Zatvori</button>
      </div>
    </div>
  </div>

  <!-- Modal for cancellation prompt -->
  <div id="cancelPromptModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
      <h2 class="text-lg font-semibold mb-4">Potvrda Otkazivanja</h2>
      <p class="text-sm mb-4">≈Ωelite li otkazati ceo termin ili samo ovaj slot?</p>
      <div class="flex justify-end space-x-2">
        <button id="cancelAll" class="bg-red-600 text-white py-1 px-3 rounded-lg hover:bg-red-700 text-sm">Ceo termin</button>
        <button id="cancelSingle" class="bg-red-600 text-white py-1 px-3 rounded-lg hover:bg-red-700 text-sm">Samo ovaj slot</button>
        <button id="closePrompt" class="bg-gray-600 text-white py-1 px-3 rounded-lg hover:bg-gray-700 text-sm">Odustani</button>
      </div>
    </div>
  </div>

  <!-- Modal for cancellation history -->
  <div id="historyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
      <h2 class="text-lg font-semibold mb-4">Istorija Otkazanih Termina</h2>
      <div id="historyContent" class="text-sm">
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-100">
              <th class="border p-2 text-xs sm:text-sm">Ime i Prezime</th>
              <th class="border p-2 text-xs sm:text-sm">Telefon</th>
              <th class="border p-2 text-xs sm:text-sm">Usluga</th>
              <th class="border p-2 text-xs sm:text-sm">Datum</th>
              <th class="border p-2 text-xs sm:text-sm">Vreme</th>
              <th class="border p-2 text-xs sm:text-sm">Otka–∑–∞–Ω–æ</th>
            </tr>
          </thead>
          <tbody id="historyTable"></tbody>
        </table>
      </div>
      <div class="flex justify-end mt-6">
        <button id="closeHistoryModal" class="bg-gray-600 text-white py-1 px-3 rounded-lg hover:bg-gray-700 text-sm">Zatvori</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    window.onload = async () => {
      if (typeof supabase === 'undefined') {
        document.getElementById('message').textContent = 'Gre≈°ka: Supabase JS nije uƒçitan.';
        document.getElementById('message').classList.add('text-red-600');
        return;
      }

      const SUPABASE_URL = 'https://xkljqcxonrnstuivtihc.supabase.co';
      let SUPABASE_ANON_KEY = localStorage.getItem('supabase_anon_key');
      if (!SUPABASE_ANON_KEY) {
        SUPABASE_ANON_KEY = prompt('Unesite Supabase anon kljuƒç:');
        if (SUPABASE_ANON_KEY && SUPABASE_ANON_KEY.length > 20) {
          localStorage.setItem('supabase_anon_key', SUPABASE_ANON_KEY);
        }
      }
      if (!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.length < 20) {
        document.getElementById('message').textContent = 'Va≈æeƒái Supabase anon kljuƒç je neophodan za nastavak.';
        document.getElementById('message').classList.add('text-red-600');
        return;
      }
      console.log('Supabase client initializing with key length:', SUPABASE_ANON_KEY.length);

      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('Supabase client initialized:', !!supabaseClient);
      const APPOINTMENTS_TABLE = 'appointments';
      const CANCELED_TABLE = 'canceled_appointments';

      const TIME_SLOTS = [
        '06:00', '06:30', '07:00', '07:30', '08:00', '08:30', '09:00', '09:30',
        '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00', '13:30',
        '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30',
        '18:00', '18:30', '19:00', '19:30', '20:00', '20:30', '21:00', '21:30',
        '22:00', '22:30', '23:00', '23:30', '00:00', '00:30'
      ];
      console.log('TIME_SLOTS:', TIME_SLOTS);

      let currentWeekStart = new Date('2025-05-24');
      currentWeekStart.setHours(0, 0, 0, 0);

      async function initializeSlots(startDate) {
        const dates = [];
        for (let i = 0; i < 7; i++) {
          const date = new Date(startDate);
          date.setDate(startDate.getDate() + i);
          if (date >= new Date('2025-05-24') && date <= new Date('2026-05-24')) {
            dates.push(date.toISOString().slice(0, 10));
          }
        }

        const slots = [];
        dates.forEach(date => {
          TIME_SLOTS.forEach(time => {
            slots.push({ date, time: `${time}:00`, available: true, is_booked: false });
          });
        });

        if (slots.length === 0) return;

        try {
          const { data, error } = await supabaseClient
            .from(APPOINTMENTS_TABLE)
            .upsert(slots, { onConflict: ['date', 'time'], ignoreDuplicates: true })
            .select();

          if (error) {
            console.error('Upsert error:', error);
            document.getElementById('message').textContent = `Gre≈°ka pri inicijalizaciji: ${error.message}`;
            document.getElementById('message').classList.add('text-red-600');
          } else {
            console.log('Initialized slots:', data.length);
          }
        } catch (err) {
          console.error('Unexpected error:', err);
          document.getElementById('message').textContent = 'Neoƒçekivana gre≈°ka.';
          document.getElementById('message').classList.add('text-red-600');
        }
      }

      async function loadWeek(startDate) {
        const dates = [];
        for (let i = 0; i < 7; i++) {
          const date = new Date(startDate);
          date.setDate(startDate.getDate() + i);
          if (date >= new Date('2025-05-24') && date <= new Date('2026-05-24')) {
            dates.push(date.toISOString().slice(0, 10));
          }
          document.getElementById(`day${i}`).textContent = date.toLocaleDateString('sr-RS', { weekday: 'short', day: 'numeric', month: 'short' });
        }

        const weekEnd = new Date(startDate);
        weekEnd.setDate(startDate.getDate() + 6);
        document.getElementById('weekDisplay').textContent = `${startDate.toLocaleDateString('sr-RS', { month: 'long', day: 'numeric' })} - ${weekEnd.toLocaleDateString('sr-RS', { month: 'long', day: 'numeric', year: 'numeric' })}`;

        if (dates.length === 0) {
          document.getElementById('slotsTable').innerHTML = '<tr><td colspan="8" class="text-center p-4">Nema dostupnih datuma u ovom opsegu.</td></tr>';
          return;
        }

        const { data, error } = await supabaseClient
          .from(APPOINTMENTS_TABLE)
          .select('date, time, available, is_booked, name_lastname, main_service, phone, sub_service, length, shape, design, notes, duration')
          .in('date', dates)
          .order('time', { ascending: true });

        if (error) {
          document.getElementById('message').textContent = `Gre≈°ka pri uƒçitavanju: ${error.message}`;
          document.getElementById('message').classList.add('text-red-600');
          console.error('Load week error:', error);
          return;
        }

        const slotsTable = document.getElementById('slotsTable');
        slotsTable.innerHTML = '';
        TIME_SLOTS.forEach(time => {
          const row = document.createElement('tr');
          row.innerHTML = `<td id="time-column" class="border p-1 sm:p-2 text-xs sm:text-sm">${time}</td>`;
          dates.forEach((date, dayIndex) => {
            const slot = data.find(d => d.date === date && d.time.slice(0, 5) === time);
            const td = document.createElement('td');
            td.classList.add('border', 'p-1', 'sm:p-2', 'text-xs', 'sm:text-sm', 'cursor-pointer');
            if (slot) {
              td.classList.add(slot.is_booked ? 'slot-booked' : slot.available ? 'slot-available' : 'slot-unavailable');
              td.innerHTML = slot.is_booked ? `${slot.name_lastname || ''}<br>${slot.main_service || ''}` : slot.available ? 'Slobodno' : 'Zatvoreno';
            } else {
              td.classList.add('slot-unavailable');
              td.textContent = 'Zatvoreno';
            }
            const handleSlotInteraction = async (e) => {
              e.preventDefault();
              console.log('Slot interaction:', { event: e.type, date, time });
              if (!slot) return;
              if (slot.is_booked) {
                // Show booking details modal
                const modal = document.getElementById('bookingModal');
                const details = document.getElementById('bookingDetails');
                details.innerHTML = `
                  <p><strong>Ime i prezime:</strong> ${slot.name_lastname || '-'}</p>
                  <p><strong>Telefon:</strong> ${slot.phone || '-'}</p>
                  <p><strong>Usluga:</strong> ${slot.main_service || '-'}</p>
                  ${slot.sub_service ? `<p><strong>Vrsta rada:</strong> ${slot.sub_service}</p>` : ''}
                  ${slot.length ? `<p><strong>Du≈æina noktiju:</strong> ${slot.length}</p>` : ''}
                  ${slot.shape ? `<p><strong>Oblik noktiju:</strong> ${slot.shape}</p>` : ''}
                  ${slot.design ? `<p><strong>Dizajn:</strong> ${slot.design}</p>` : ''}
                  ${slot.notes ? `<p><strong>Napomene:</strong> ${slot.notes}</p>` : ''}
                  <p><strong>Trajanje:</strong> ${slot.duration || '-'} min</p>
                  <p><strong>Datum:</strong> ${new Date(slot.date).toLocaleDateString('sr-RS')}</p>
                  <p><strong>Vreme:</strong> ${slot.time.slice(0, 5)}</p>
                `;
                modal.classList.remove('hidden');

                const cancelButton = document.getElementById('cancelBooking');
                cancelButton.onclick = async () => {
                  try {
                    // Check if multi-slot and first/last
                    const duration = slot.duration || 30;
                    const slotCount = Math.ceil(duration / 30);
                    if (slotCount > 1) {
                      const clickedTime = slot.time.slice(0, 5);
                      const clickedMinutes = parseInt(clickedTime.split(':')[0]) * 60 + parseInt(clickedTime.split(':')[1]);
                      // Query to find the appointment's start time
                      const { data: appointmentSlots, error: fetchError } = await supabaseClient
                        .from(APPOINTMENTS_TABLE)
                        .select('time')
                        .eq('date', date)
                        .eq('name_lastname', slot.name_lastname)
                        .eq('duration', duration)
                        .eq('is_booked', true)
                        .order('time', { ascending: true });
                      if (fetchError) {
                        console.error('Fetch appointment slots error:', fetchError);
                        document.getElementById('message').textContent = `Gre≈°ka pri dohvatanju termina: ${fetchError.message}`;
                        document.getElementById('message').classList.add('text-red-600');
                        return;
                      }
                      if (appointmentSlots.length > 0) {
                        const startTime = appointmentSlots[0].time.slice(0, 5);
                        const startMinutes = parseInt(startTime.split(':')[0]) * 60 + parseInt(startTime.split(':')[1]);
                        const endMinutes = startMinutes + duration - 30;
                        const isFirstOrLast = clickedMinutes === startMinutes || clickedMinutes === endMinutes;
                        if (isFirstOrLast) {
                          // Show cancellation prompt
                          const promptModal = document.getElementById('cancelPromptModal');
                          promptModal.classList.remove('hidden');
                          document.getElementById('cancelAll').onclick = async () => {
                            await cancelAppointment(date, slot.name_lastname, duration, slot);
                            promptModal.classList.add('hidden');
                            modal.classList.add('hidden');
                            await loadWeek(startDate);
                          };
                          document.getElementById('cancelSingle').onclick = async () => {
                            await cancelSingleSlot(date, time, slot);
                            promptModal.classList.add('hidden');
                            modal.classList.add('hidden');
                            await loadWeek(startDate);
                          };
                          document.getElementById('closePrompt').onclick = () => {
                            promptModal.classList.add('hidden');
                          };
                          promptModal.onclick = (e) => {
                            if (e.target === promptModal) {
                              promptModal.classList.add('hidden');
                            }
                          };
                          return;
                        }
                      }
                    }
                    // Default: cancel entire appointment
                    await cancelAppointment(date, slot.name_lastname, duration, slot);
                    modal.classList.add('hidden');
                    await loadWeek(startDate);
                  } catch (err) {
                    console.error('Unexpected cancel error:', err);
                    document.getElementById('message').textContent = 'Neoƒçekivana gre≈°ka pri otkazivanju.';
                    document.getElementById('message').classList.add('text-red-600');
                  }
                };
              } else {
                // Toggle availability
                const newAvailable = !slot.available;
                console.log('Updating slot:', { date, time, newAvailable });
                try {
                  const { error } = await supabaseClient
                    .from(APPOINTMENTS_TABLE)
                    .update({ available: newAvailable })
                    .eq('date', date)
                    .eq('time', `${time}:00`);
                  if (error) {
                    console.error('Update error:', error);
                    document.getElementById('message').textContent = `Gre≈°ka pri a≈æuriranju: ${error.message}`;
                    document.getElementById('message').classList.add('text-red-600');
                  } else {
                    // Refresh slot data
                    const { data: updatedSlot, error: fetchError } = await supabaseClient
                      .from(APPOINTMENTS_TABLE)
                      .select('available, is_booked, name_lastname, main_service')
                      .eq('date', date)
                      .eq('time', `${time}:00`)
                      .single();
                    if (fetchError) {
                      console.error('Fetch slot error:', fetchError);
                      document.getElementById('message').textContent = `Gre≈°ka pri osvje≈æavanju: ${fetchError.message}`;
                      document.getElementById('message').classList.add('text-red-600');
                    } else {
                      td.classList.toggle('slot-available', updatedSlot.available && !updatedSlot.is_booked);
                      td.classList.toggle('slot-unavailable', !updatedSlot.available);
                      td.innerHTML = updatedSlot.is_booked ? `${updatedSlot.name_lastname || ''}<br>${updatedSlot.main_service || ''}` : updatedSlot.available ? 'Slobodno' : 'Zatvoreno';
                      console.log('Slot updated successfully:', { date, time, available: updatedSlot.available });
                      await loadWeek(startDate);
                    }
                  }
                } catch (err) {
                  console.error('Unexpected update error:', err);
                  document.getElementById('message').textContent = 'Neoƒçekivana gre≈°ka pri a≈æuriranju.';
                  document.getElementById('message').classList.add('text-red-600');
                }
              }
            };
            td.addEventListener('click', handleSlotInteraction);
            td.addEventListener('touchend', handleSlotInteraction);
            row.appendChild(td);
          });
          slotsTable.appendChild(row);
        });

        // Modal close handlers
        document.getElementById('closeModal').onclick = () => {
          document.getElementById('bookingModal').classList.add('hidden');
        };
        document.getElementById('bookingModal').onclick = (e) => {
          if (e.target === document.getElementById('bookingModal')) {
            document.getElementById('bookingModal').classList.add('hidden');
          }
        };
      }

      async function cancelAppointment(date, name_lastname, duration, slotData) {
        // Fetch all slots for the appointment
        const { data: appointmentSlots, error: fetchError } = await supabaseClient
          .from(APPOINTMENTS_TABLE)
          .select('time, name_lastname, phone, main_service, sub_service, length, shape, design, notes, duration, date')
          .eq('date', date)
          .eq('name_lastname', name_lastname)
          .eq('duration', duration)
          .eq('is_booked', true)
          .order('time', { ascending: true });
        if (fetchError) {
          console.error('Fetch appointment slots error:', fetchError);
          document.getElementById('message').textContent = `Gre≈°ka pri dohvatanju termina: ${fetchError.message}`;
          document.getElementById('message').classList.add('text-red-600');
          return;
        }
        const times = appointmentSlots.map(slot => slot.time);
        console.log('Canceling appointment:', { date, name_lastname, duration, times });

        // Save to canceled_appointments (use first slot's data)
        if (appointmentSlots.length > 0) {
          const firstSlot = appointmentSlots[0];
          const { error: insertError } = await supabaseClient
            .from(CANCELED_TABLE)
            .insert({
              name_lastname: firstSlot.name_lastname,
              phone: firstSlot.phone,
              main_service: firstSlot.main_service,
              sub_service: firstSlot.sub_service,
              length: firstSlot.length,
              shape: firstSlot.shape,
              design: firstSlot.design,
              notes: firstSlot.notes,
              duration: firstSlot.duration,
              date: firstSlot.date,
              start_time: firstSlot.time
            });
          if (insertError) {
            console.error('Insert canceled appointment error:', insertError);
            document.getElementById('message').textContent = `Gre≈°ka pri ƒçuvanju otkazanog termina: ${insertError.message}`;
            document.getElementById('message').classList.add('text-red-600');
          } else {
            console.log('Saved canceled appointment:', { date, start_time: firstSlot.time });
          }
        }

        // Clear appointment slots
        const { error } = await supabaseClient
          .from(APPOINTMENTS_TABLE)
          .update({
            is_booked: false,
            available: true,
            name_lastname: null,
            phone: null,
            main_service: null,
            sub_service: null,
            length: null,
            shape: null,
            design: null,
            notes: null,
            duration: null
          })
          .eq('date', date)
          .in('time', times);
        if (error) {
          console.error('Cancel appointment error:', error);
          document.getElementById('message').textContent = `Gre≈°ka pri otkazivanju termina: ${error.message}`;
          document.getElementById('message').classList.add('text-red-600');
        } else {
          console.log('Appointment canceled:', { date, times });
        }
      }

      async function cancelSingleSlot(date, time, slotData) {
        // Save to canceled_appointments
        const { error: insertError } = await supabaseClient
          .from(CANCELED_TABLE)
          .insert({
            name_lastname: slotData.name_lastname,
            phone: slotData.phone,
            main_service: slotData.main_service,
            sub_service: slotData.sub_service,
            length: slotData.length,
            shape: slotData.shape,
            design: slotData.design,
            notes: slotData.notes,
            duration: slotData.duration,
            date: slotData.date,
            start_time: slotData.time
          });
        if (insertError) {
          console.error('Insert canceled slot error:', insertError);
          document.getElementById('message').textContent = `Gre≈°ka pri ƒçuvanju otkazanog slota: ${insertError.message}`;
          document.getElementById('message').classList.add('text-red-600');
        } else {
          console.log('Saved canceled slot:', { date, time });
        }

        // Clear single slot
        const { error } = await supabaseClient
          .from(APPOINTMENTS_TABLE)
          .update({
            is_booked: false,
            available: true,
            name_lastname: null,
            phone: null,
            main_service: null,
            sub_service: null,
            length: null,
            shape: null,
            design: null,
            notes: null,
            duration: null
          })
          .eq('date', date)
          .eq('time', `${time}:00`);
        if (error) {
          console.error('Cancel single slot error:', error);
          document.getElementById('message').textContent = `Gre≈°ka pri otkazivanju slota: ${error.message}`;
          document.getElementById('message').classList.add('text-red-600');
        } else {
          console.log('Single slot canceled:', { date, time });
        }
      }

      async function loadCancellationHistory() {
        const { data, error } = await supabaseClient
          .from(CANCELED_TABLE)
          .select('name_lastname, phone, main_service, date, start_time, canceled_at')
          .order('canceled_at', { ascending: false })
          .limit(15);
        if (error) {
          console.error('Fetch cancellation history error:', error);
          document.getElementById('message').textContent = `Gre≈°ka pri uƒçitavanju istorije: ${error.message}`;
          document.getElementById('message').classList.add('text-red-600');
          return;
        }
        const historyTable = document.getElementById('historyTable');
        historyTable.innerHTML = '';
        if (data.length === 0) {
          historyTable.innerHTML = '<tr><td colspan="6" class="border p-2 text-center">Nema otkazanih termina.</td></tr>';
          return;
        }
        data.forEach(record => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="border p-2 text-xs sm:text-sm">${record.name_lastname || '-'}</td>
            <td class="border p-2 text-xs sm:text-sm">${record.phone || '-'}</td>
            <td class="border p-2 text-xs sm:text-sm">${record.main_service || '-'}</td>
            <td class="border p-2 text-xs sm:text-sm">${new Date(record.date).toLocaleDateString('sr-RS')}</td>
            <td class="border p-2 text-xs sm:text-sm">${record.start_time.slice(0, 5)}</td>
            <td class="border p-2 text-xs sm:text-sm">${new Date(record.canceled_at).toLocaleString('sr-RS')}</td>
          `;
          historyTable.appendChild(row);
        });
      }

      document.getElementById('historyButton').addEventListener('click', async () => {
        const modal = document.getElementById('historyModal');
        await loadCancellationHistory();
        modal.classList.remove('hidden');
      });

      document.getElementById('closeHistoryModal').addEventListener('click', () => {
        document.getElementById('historyModal').classList.add('hidden');
      });

      document.getElementById('historyModal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('historyModal')) {
          document.getElementById('historyModal').classList.add('hidden');
        }
      });

      document.getElementById('prevWeek').addEventListener('click', async () => {
        currentWeekStart.setDate(currentWeekStart.getDate() - 7);
        await initializeSlots(currentWeekStart);
        await loadWeek(currentWeekStart);
      });

      document.getElementById('nextWeek').addEventListener('click', async () => {
        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
        await initializeSlots(currentWeekStart);
        await loadWeek(currentWeekStart);
      });

      await initializeSlots(currentWeekStart);
      await loadWeek(currentWeekStart);
    };
  </script>
</body>
</html>
