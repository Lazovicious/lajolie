<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin: Manage Available Time Slots</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background-color: #f9f9f9;
    }
    h1 {
      margin-bottom: 1rem;
    }
    .calendar {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .day-block {
      background: #fff;
      padding: 1rem;
      border: 1px solid #ccc;
    }
    .slots {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .slot {
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
      border: 1px solid transparent;
    }
    .available {
      background-color: #c8f7c5;
      border-color: #27ae60;
    }
    .unavailable {
      background-color: #f0f0f0;
      color: #aaa;
      border-color: #ccc;
      cursor: not-allowed;
    }
    .booked {
      background-color: #f7c5c5;
      border-color: #e74c3c;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Admin: Manage Available Time Slots</h1>
  <div class="calendar" id="calendar"></div>

  <script>
    (async () => {
      // --- Config: replace with your own Supabase URL and anon key ---
      const SUPABASE_URL = 'https://xkljqcxonrnstuivtihc.supabase.co'; // Your Supabase URL
      const SUPABASE_ANON_KEY = prompt('Enter Supabase anon key for admin:');
      if (!SUPABASE_ANON_KEY) {
        alert('Admin key is required. Reload page to try again.');
        return;
      }

      const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Table names
      const AVAILABILITY_TABLE = 'availability_slots';
      const BOOKINGS_TABLE = 'jolie_t1';

      // Utility: generate 30-min slots array for a given day
      function generateSlotsForDay(dateStr) {
        const slots = [];
        for (let hour = 8; hour <= 20; hour++) {
          for (let min of [0, 30]) {
            const time = `${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
            slots.push({ date: dateStr, time });
          }
        }
        return slots;
      }

      // Create date strings for next 14 days
      function getNextNDays(n) {
        const days = [];
        const today = new Date();
        for (let i = 0; i < n; i++) {
          const d = new Date(today);
          d.setDate(today.getDate() + i);
          const iso = d.toISOString().split('T')[0];
          days.push(iso);
        }
        return days;
      }

      // Load current availability + booked
      async function loadAvailabilityAndBookings() {
        const { data: availability } = await supabaseClient.from(AVAILABILITY_TABLE).select('*');
        const { data: bookings } = await supabaseClient.from(BOOKINGS_TABLE).select('date,time');

        return { availability: availability || [], bookings: bookings || [] };
      }

      // Update availability in Supabase
      async function toggleSlot(date, time, makeAvailable) {
        const { data, error } = await supabaseClient
          .from(AVAILABILITY_TABLE)
          .select('*')
          .eq('date', date)
          .eq('time', time);

        if (data && data.length > 0) {
          if (!makeAvailable) {
            await supabaseClient.from(AVAILABILITY_TABLE)
              .delete()
              .eq('date', date)
              .eq('time', time);
          }
        } else {
          if (makeAvailable) {
            await supabaseClient.from(AVAILABILITY_TABLE)
              .insert([{ date, time, available: true }]);
          }
        }
        renderCalendar(); // Refresh view
      }

      // Render calendar UI
      async function renderCalendar() {
        const calendarEl = document.getElementById('calendar');
        calendarEl.innerHTML = '';

        const days = getNextNDays(14);
        const { availability, bookings } = await loadAvailabilityAndBookings();

        days.forEach(date => {
          const slots = generateSlotsForDay(date);
          const dayBlock = document.createElement('div');
          dayBlock.className = 'day-block';

          const title = document.createElement('strong');
          title.innerText = `${date}`;
          dayBlock.appendChild(title);

          const slotsContainer = document.createElement('div');
          slotsContainer.className = 'slots';

          slots.forEach(({ time }) => {
            const slotEl = document.createElement('div');
            slotEl.className = 'slot';

            const isBooked = bookings.some(b => b.date === date && b.time === time);
            const isAvailable = availability.some(a => a.date === date && a.time === time);

            if (isBooked) {
              slotEl.classList.add('booked');
              slotEl.innerText = time;
              slotEl.title = 'Booked';
            } else if (isAvailable) {
              slotEl.classList.add('available');
              slotEl.innerText = time;
              slotEl.title = 'Click to remove';
              slotEl.onclick = () => toggleSlot(date, time, false);
            } else {
              slotEl.classList.add('unavailable');
              slotEl.innerText = time;
              slotEl.title = 'Click to make available';
              slotEl.onclick = () => toggleSlot(date, time, true);
              slotEl.classList.remove('unavailable');
              slotEl.style.backgroundColor = '#eee';
            }

            slotsContainer.appendChild(slotEl);
          });

          dayBlock.appendChild(slotsContainer);
          calendarEl.appendChild(dayBlock);
        });
      }

      await renderCalendar();
    })();
  </script>
</body>
</html>
