<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <title>Admin: Manage Available Time Slots</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    .calendar {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }

    .day {
      border: 1px solid #ccc;
      padding: 10px;
      width: 180px;
    }

    .day strong {
      display: block;
      margin-bottom: 8px;
    }

    .slot {
      margin: 3px 0;
      padding: 4px 6px;
      border-radius: 4px;
      cursor: pointer;
      text-align: center;
    }

    .available {
      background-color: #d4edda;
      color: #155724;
    }

    .unavailable {
      background-color: #f8d7da;
      color: #721c24;
    }

    .booked {
      background-color: #ccc;
      color: #333;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Admin: Manage Available Time Slots</h1>
  <div class="calendar" id="calendar"></div>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.6/+esm"></script>

  <script>
    (async () => {
      const SUPABASE_URL = 'https://xkljqcxonrnstuivtihc.supabase.co';
      const SUPABASE_ANON_KEY = prompt('Enter Supabase anon key for admin:');
      if (!SUPABASE_ANON_KEY) {
        alert('Admin key is required. Reload page to try again.');
        return;
      }

      const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const AVAILABILITY_TABLE = 'availability_slots';
      const BOOKINGS_TABLE = 'jolie_t1';

      function getNextNDays(n) {
        const days = [];
        const today = new Date();
        for (let i = 0; i < n; i++) {
          const date = new Date(today);
          date.setDate(today.getDate() + i);
          days.push(date.toISOString().split('T')[0]);
        }
        return days;
      }

      function getSerbianDayName(dateStr) {
        const days = ['Nedelja', 'Ponedeljak', 'Utorak', 'Sreda', 'Četvrtak', 'Petak', 'Subota'];
        const dayIndex = new Date(dateStr).getDay();
        return days[dayIndex];
      }

      function getSlotsForDay() {
        const slots = [];
        for (let h = 9; h <= 18; h++) {
          slots.push(`${h.toString().padStart(2, '0')}:00`);
          slots.push(`${h.toString().padStart(2, '0')}:30`);
        }
        return slots;
      }

      const availableSlots = new Set();
      const bookedSlots = new Set();

      async function loadSlots() {
        // Load current availability
        const { data: available, error: availError } = await supabase
          .from(AVAILABILITY_TABLE)
          .select('date,time')
          .eq('available', true);

        if (availError) {
          console.error('Error loading availability:', availError);
        } else {
          available.forEach(slot => {
            availableSlots.add(`${slot.date}_${slot.time}`);
          });
        }

        // Load current bookings
        const { data: bookings, error: bookError } = await supabase
          .from(BOOKINGS_TABLE)
          .select('date,time');

        if (bookError) {
          console.error('Error loading bookings:', bookError);
        } else {
          bookings.forEach(slot => {
            bookedSlots.add(`${slot.date}_${slot.time}`);
          });
        }
      }

      async function toggleSlot(date, time, makeAvailable) {
        const key = `${date}_${time}`;
        if (makeAvailable) {
          const { error } = await supabase
            .from(AVAILABILITY_TABLE)
            .insert([{ date, time, available: true }]);
          if (!error) {
            availableSlots.add(key);
          }
        } else {
          const { error } = await supabase
            .from(AVAILABILITY_TABLE)
            .delete()
            .eq('date', date)
            .eq('time', time);
          if (!error) {
            availableSlots.delete(key);
          }
        }

        renderCalendar(); // Refresh UI
      }

      function renderCalendar() {
        const calendar = document.getElementById('calendar');
        calendar.innerHTML = '';

        getNextNDays(10).forEach(date => {
          const dayBlock = document.createElement('div');
          dayBlock.classList.add('day');

          const title = document.createElement('strong');
          const dayName = getSerbianDayName(date);
          title.innerText = `${dayName}, ${date}`;
          dayBlock.appendChild(title);

          getSlotsForDay().forEach(time => {
            const key = `${date}_${time}`;
            const slotEl = document.createElement('div');
            slotEl.classList.add('slot');
            slotEl.innerText = time;

            if (bookedSlots.has(key)) {
              slotEl.classList.add('booked');
              slotEl.title = 'Već rezervisano';
            } else if (availableSlots.has(key)) {
              slotEl.classList.add('available');
              slotEl.title = 'Klikni da ukloniš';
              slotEl.onclick = () => toggleSlot(date, time, false);
            } else {
              slotEl.classList.add('unavailable');
              slotEl.title = 'Klikni da dodaš';
              slotEl.onclick = () => toggleSlot(date, time, true);
            }

            dayBlock.appendChild(slotEl);
          });

          calendar.appendChild(dayBlock);
        });
      }

      await loadSlots();
      renderCalendar();
    })();
  </script>
</body>
</html>
