<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - Upravljanje Terminima</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📅</text></svg>" />
  <style>
    select:invalid { color: gray; }
    option[disabled][hidden] { display: none; }
    .slot-available { background-color: #d1fae5; }
    .slot-booked { background-color: #fee2e2; }
    .slot-unavailable { background-color: #e5e7eb; }
    .slot-completed { background-color: #166534; color: white; }
    .loading-overlay {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.7);
      align-items: center;
      justify-content: center;
      z-index: 20;
      border-radius: 1rem;
    }
    .loading-overlay.active {
      display: flex;
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #db2777;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @media (max-width: 640px) {
      table { font-size: 0.75rem; }
      th, td { padding: 0.25rem; }
      #time-column { position: sticky; left: 0; background: #f9fafb; z-index: 10; }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-[#f2eaea] to-[#e2d3d3] min-h-screen flex flex-col items-center p-4">
  <div class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg w-full max-w-4xl p-4 sm:p-6 relative">
    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
    </div>
    <h1 class="text-xl font-bold text-gray-800 mb-4 text-center">Upravljanje Terminima</h1>
    <div class="flex justify-between items-center mb-4">
      <button id="prevWeek" class="bg-pink-600 text-white py-1 px-2 rounded-lg hover:bg-pink-700 text-sm">Prethodna</button>
      <span id="weekDisplay" class="text-base font-semibold flex-1 text-center"></span>
      <button id="nextWeek" class="bg-pink-600 text-white py-1 px-2 rounded-lg hover:bg-pink-700 text-sm">Sledeća</button>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full border-collapse">
        <thead>
          <tr class="bg-gray-100">
            <th id="time-column" class="border p-1 sm:p-2 text-xs sm:text-sm">Vreme</th>
            <th id="day0" class="border p-1 sm:p-2 text-xs sm:text-sm"></th>
            <th id="day1" class="border p-1 sm:p-2 text-xs sm:text-sm"></th>
            <th id="day2" class="border p-1 sm:p-2 text-xs sm:text-sm"></th>
            <th id="day3" class="border p-1 sm:p-2 text-xs sm:text-sm"></th>
            <th id="day4" class="border p-1 sm:p-2 text-xs sm:text-sm"></th>
            <th id="day5" class="border p-1 sm:p-2 text-xs sm:text-sm"></th>
            <th id="day6" class="border p-1 sm:p-2 text-xs sm:text-sm"></th>
          </tr>
        </thead>
        <tbody id="slotsTable"></tbody>
      </table>
    </div>
    <div class="mt-4 flex justify-center space-x-4">
      <button id="historyButton" class="bg-blue-600 text-white py-1 px-4 rounded-lg hover:bg-blue-700 text-sm">Istorija otkazanih termina</button>
      <button id="completedHistoryButton" class="bg-green-600 text-white py-1 px-4 rounded-lg hover:bg-green-700 text-sm">Istorija završenih termina</button>
    </div>
    <div id="message" class="mt-4 text-center text-sm font-semibold"></div>
  </div>

  <!-- Modal for booked slot details -->
  <div id="bookingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
      <h2 class="text-lg font-semibold mb-4">Detalji Rezervacije</h2>
      <div id="bookingDetails" class="space-y-2 text-sm"></div>
      <div class="flex justify-between mt-6">
        <button id="cancelBooking" class="bg-red-600 text-white py-1 px-3 rounded-lg hover:bg-red-700 text-sm">Otkaži</button>
        <button id="completeBooking" class="bg-green-600 text-white py-1 px-3 rounded-lg hover:bg-green-700 text-sm">Završeno</button>
        <button id="closeModal" class="bg-gray-600 text-white py-1 px-3 rounded-lg hover:bg-gray-700 text-sm">Zatvori</button>
      </div>
    </div>
  </div>

  <!-- Modal for completion prompt -->
  <div id="completeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
      <h2 class="text-lg font-semibold mb-4">Završi Termin</h2>
      <p class="text-sm mb-4">Unesite iznos naplaćen za termin (RSD):</p>
      <input type="number" id="amountCharged" class="w-full p-2 border rounded-lg mb-4 text-sm" placeholder="npr. 1500" step="0.01" min="0" required />
      <div class="flex justify-end space-x-2">
        <button id="submitComplete" class="bg-green-600 text-white py-1 px-3 rounded-lg hover:bg-green-700 text-sm">Potvrdi</button>
        <button id="cancelComplete" class="bg-gray-600 text-white py-1 px-3 rounded-lg hover:bg-gray-700 text-sm">Odustani</button>
      </div>
    </div>
  </div>

  <!-- Modal for cancellation prompt -->
  <div id="cancelPromptModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
      <h2 class="text-lg font-semibold mb-4">Potvrda Otkazivanja</h2>
      <p class="text-sm mb-4">Želite li otkazati ceo termin ili samo ovaj slot?</p>
      <div class="flex justify-end space-x-2">
        <button id="cancelAll" class="bg-red-600 text-white py-1 px-3 rounded-lg hover:bg-red-700 text-sm">Ceo termin</button>
        <button id="cancelSingle" class="bg-red-600 text-white py-1 px-3 rounded-lg hover:bg-red-700 text-sm">Samo ovaj slot</button>
        <button id="closePrompt" class="bg-gray-600 text-white py-1 px-3 rounded-lg hover:bg-gray-700 text-sm">Odustani</button>
      </div>
    </div>
  </div>

  <!-- Modal for cancellation history -->
  <div id="historyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
      <h2 class="text-lg font-semibold mb-4">Istorija Otkazanih Termina</h2>
      <div id="historyContent" class="text-sm">
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-100">
              <th class="border p-2 text-xs sm:text-sm">Ime i Prezime</th>
              <th class="border p-2 text-xs sm:text-sm">Telefon</th>
              <th class="border p-2 text-xs sm:text-sm">Usluga</th>
              <th class="border p-2 text-xs sm:text-sm">Datum</th>
              <th class="border p-2 text-xs sm:text-sm">Vreme</th>
              <th class="border p-2 text-xs sm:text-sm">Otkazano</th>
            </tr>
          </thead>
          <tbody id="historyTable"></tbody>
        </table>
      </div>
      <div class="flex justify-end mt-6">
        <button id="closeHistoryModal" class="bg-gray-600 text-white py-1 px-3 rounded-lg hover:bg-gray-700 text-sm">Zatvori</button>
      </div>
    </div>
  </div>

  <!-- Modal for completed appointments history -->
  <div id="completedHistoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
      <h2 class="text-lg font-semibold mb-4">Istorija Završenih Termina</h2>
      <div id="completedHistoryContent" class="text-sm">
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-100">
              <th class="border p-2 text-xs sm:text-sm">Ime i Prezime</th>
              <th class="border p-2 text-xs sm:text-sm">Usluga</th>
              <th class="border p-2 text-xs sm:text-sm">Datum</th>
              <th class="border p-2 text-xs sm:text-sm">Vreme</th>
              <th class="border p-2 text-xs sm:text-sm">Iznos (RSD)</th>
              <th class="border p-2 text-xs sm:text-sm">Završeno</th>
            </tr>
          </thead>
          <tbody id="completedHistoryTable"></tbody>
        </table>
        <div id="totals" class="mt-4 text-sm font-semibold">
          <p>Ukupno: <span id="totalAmount">0,00</span> RSD</p>
          <p>Ovaj mesec: <span id="monthlyAmount">0,00</span> RSD</p>
        </div>
      </div>
      <div class="flex justify-end mt-6">
        <button id="closeCompletedHistoryModal" class="bg-gray-600 text-white py-1 px-3 rounded-lg hover:bg-gray-700 text-sm">Zatvori</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    window.onload = async () => {
      if (typeof supabase === 'undefined') {
        document.getElementById('message').textContent = 'Greška: Supabase JS nije učitan.';
        document.getElementById('message').classList.add('text-red-600');
        return;
      }

      const SUPABASE_URL = 'https://xkljqcxonrnstuivtihc.supabase.co';
      let SUPABASE_ANON_KEY = localStorage.getItem('supabase_anon_key');
      if (!SUPABASE_ANON_KEY) {
        SUPABASE_ANON_KEY = prompt('Unesite Supabase anon ključ:');
        if (SUPABASE_ANON_KEY && SUPABASE_ANON_KEY.length > 20) {
          localStorage.setItem('supabase_anon_key', SUPABASE_ANON_KEY);
        }
      }
      if (!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.length < 20) {
        document.getElementById('message').textContent = 'Važeći Supabase anon ključ je neophodan za nastavak.';
        document.getElementById('message').classList.add('text-red-600');
        return;
      }
      console.log('Supabase client initializing with key length:', SUPABASE_ANON_KEY.length);

      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const APPOINTMENTS_TABLE = 'appointments';
      const CANCELED_TABLE = 'canceled_appointments';
      const COMPLETED_TABLE = 'completed_appointments';

      const TIME_SLOTS = [
        '06:00', '06:30', '07:00', '07:30', '08:00', '08:30', '09:00', '09:30',
        '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00', '13:30',
        '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30',
        '18:00', '18:30', '19:00', '19:30', '20:00', '20:30', '21:00', '21:30',
        '22:00', '22:30', '23:00', '23:30', '00:00', '00:30'
      ];

      let currentWeekStart = new Date('2025-05-24');
      currentWeekStart.setHours(0, 0, 0, 0);

      const loadingOverlay = document.getElementById('loadingOverlay');

      function showLoading() {
        loadingOverlay.classList.add('active');
      }

      function hideLoading() {
        loadingOverlay.classList.remove('active');
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat('sr-RS', { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount) + ' RSD';
      }

      async function initializeSlots(startDate) {
        showLoading();
        try {
          const dates = [];
          for (let i = 0; i < 7; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);
            if (date >= new Date('2025-05-24') && date <= new Date('2026-05-24')) {
              dates.push(date.toISOString().slice(0, 10));
            }
          }

          const slots = [];
          dates.forEach(date => {
            TIME_SLOTS.forEach(time => {
              slots.push({ date, time: `${time}:00`, available: true, is_booked: false, is_completed: false });
            });
          });

          if (slots.length === 0) return;

          const { data, error } = await supabaseClient
            .from(APPOINTMENTS_TABLE)
            .upsert(slots, { onConflict: ['date', 'time'], ignoreDuplicates: true })
            .select();

          if (error) {
            console.error('Upsert error:', error);
            document.getElementById('message').textContent = `Greška pri inicijalizaciji: ${error.message}`;
            document.getElementById('message').classList.add('text-red-600');
          } else {
            console.log('Initialized slots:', data.length);
          }
        } finally {
          hideLoading();
        }
      }

      async function loadWeek(startDate) {
        showLoading();
        try {
          const dates = [];
          for (let i = 0; i < 7; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);
            if (date >= new Date('2025-05-24') && date <= new Date('2026-05-24')) {
              dates.push(date.toISOString().slice(0, 10));
            }
            document.getElementById(`day${i}`).textContent = date.toLocaleDateString('sr-RS', { weekday: 'short', day: 'numeric', month: 'short' });
          }

          const weekEnd = new Date(startDate);
          weekEnd.setDate(startDate.getDate() + 6);
          document.getElementById('weekDisplay').textContent = `${startDate.toLocaleDateString('sr-RS', { month: 'long', day: 'numeric' })} - ${weekEnd.toLocaleDateString('sr-RS', { month: 'long', day: 'numeric', year: 'numeric' })}`;

          if (dates.length === 0) {
            document.getElementById('slotsTable').innerHTML = '<tr><td colspan="8" class="text-center p-4">Nema dostupnih datuma u ovom opsegu.</td></tr>';
            return;
          }

          const { data, error } = await supabaseClient
            .from(APPOINTMENTS_TABLE)
            .select('date, time, available, is_booked, is_completed, name_lastname, main_service, phone, sub_service, length, shape, design, notes, duration, amount_charged')
            .in('date', dates)
            .order('time', { ascending: true });

          if (error) {
            document.getElementById('message').textContent = `Greška pri učitavanju: ${error.message}`;
            document.getElementById('message').classList.add('text-red-600');
            console.error('Load week error:', error);
            return;
          }

          const slotsTable = document.getElementById('slotsTable');
          slotsTable.innerHTML = '';
          TIME_SLOTS.forEach(time => {
            const row = document.createElement('tr');
            row.innerHTML = `<td id="time-column" class="border p-1 sm:p-2 text-xs sm:text-sm">${time}</td>`;
            dates.forEach((date, dayIndex) => {
              const slot = data.find(d => d.date === date && d.time.slice(0, 5) === time);
              const td = document.createElement('td');
              td.classList.add('border', 'p-1', 'sm:p-2', 'text-xs', 'sm:text-sm', 'cursor-pointer');
              if (slot) {
                if (slot.is_completed) {
                  td.classList.add('slot-completed');
                  td.innerHTML = `${slot.name_lastname || ''}<br>${slot.main_service || ''}<br>${formatCurrency(slot.amount_charged || 0)}`;
                } else {
                  td.classList.add(slot.is_booked ? 'slot-booked' : slot.available ? 'slot-available' : 'slot-unavailable');
                  td.innerHTML = slot.is_booked ? `${slot.name_lastname || ''}<br>${slot.main_service || ''}` : slot.available ? 'Slobodno' : 'Zatvoreno';
                }
              } else {
                td.classList.add('slot-unavailable');
                td.textContent = 'Zatvoreno';
              }

              let touchStartX = 0;
              let touchStartY = 0;
              let touchStartTime = 0;
              let isScrolling = false;

              const handleSlotInteraction = async (e) => {
                e.preventDefault();
                console.log('Slot interaction:', { event: e.type, date, time });
                if (!slot) return;
                showLoading();
                try {
                  const { data: currentSlot, error: fetchError } = await supabaseClient
                    .from(APPOINTMENTS_TABLE)
                    .select('available, is_booked, is_completed, name_lastname, main_service, phone, sub_service, length, shape, design, notes, duration, amount_charged')
                    .eq('date', date)
                    .eq('time', `${time}:00`)
                    .single();
                  if (fetchError) {
                    console.error('Fetch slot error:', fetchError);
                    document.getElementById('message').textContent = `Greška pri proveri slota: ${fetchError.message}`;
                    document.getElementById('message').classList.add('text-red-600');
                    return;
                  }
                  if (currentSlot.is_booked || currentSlot.is_completed) {
                    const modal = document.getElementById('bookingModal');
                    const details = document.getElementById('bookingDetails');
                    const fields = [
                      { key: 'name_lastname', label: 'Ime i prezime' },
                      { key: 'phone', label: 'Telefon' },
                      { key: 'main_service', label: 'Usluga' },
                      { key: 'sub_service', label: 'Vrsta rada' },
                      { key: 'length', label: 'Dužina noktiju' },
                      { key: 'shape', label: 'Oblik noktiju' },
                      { key: 'design', label: 'Dizajn' },
                      { key: 'notes', label: 'Napomene' },
                      { key: 'duration', label: 'Trajanje', format: v => `${v || '-'} min` },
                      { key: 'date', label: 'Datum', format: v => new Date(v).toLocaleDateString('sr-RS') },
                      { key771: 'time', label: 'Vreme', format: v => v.slice(0, 5) },
                      { key: 'amount_charged', label: 'Naplaćeno', format: v => v ? formatCurrency(v) : '-' }
                    ];
                    details.innerHTML = fields
                      .filter(f => currentSlot[f.key])
                      .map(f => `<p><strong>${f.label}:</strong> ${f.format ? f.format(currentSlot[f.key]) : currentSlot[f.key]}</p>`)
                      .join('');
                    modal.classList.remove('hidden');

                    const cancelButton = document.getElementById('cancelBooking');
                    const completeButton = document.getElementById('completeBooking');
                    cancelButton.disabled = currentSlot.is_completed;
                    completeButton.disabled = currentSlot.is_completed;
                    if (currentSlot.is_completed) {
                      cancelButton.classList.add('opacity-50', 'cursor-not-allowed');
                      completeButton.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                      cancelButton.classList.remove('opacity-50', 'cursor-not-allowed');
                      completeButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    }

                    cancelButton.onclick = async () => {
                      if (currentSlot.is_completed) return;
                      try {
                        const duration = currentSlot.duration || 30;
                        const slotCount = Math.ceil(duration / 30);
                        if (slotCount > 1) {
                          const clickedTime = currentSlot.time.slice(0, 5);
                          const clickedMinutes = parseInt(clickedTime.split(':')[0]) * 60 + parseInt(clickedTime.split(':')[1]);
                          const { data: appointmentSlots, error: fetchError } = await supabaseClient
                            .from(APPOINTMENTS_TABLE)
                            .select('time')
                            .eq('date', date)
                            .eq('name_lastname', currentSlot.name_lastname)
                            .eq('duration', duration)
                            .eq('is_booked', true)
                            .order('time', { ascending: true });
                          if (fetchError) {
                            console.error('Fetch appointment slots error:', fetchError);
                            document.getElementById('message').textContent = `Greška pri dohvatanju termina: ${fetchError.message}`;
                            document.getElementById('message').classList.add('text-red-600');
                            return;
                          }
                          if (appointmentSlots.length > 0) {
                            const startTime = appointmentSlots[0].time.slice(0, 5);
                            const startMinutes = parseInt(startTime.split(':')[0]) * 60 + parseInt(startTime.split(':')[1]);
                            const endMinutes = startMinutes + duration - 30;
                            const isFirstOrLast = clickedMinutes === startMinutes || clickedMinutes === endMinutes;
                            if (isFirstOrLast) {
                              const promptModal = document.getElementById('cancelPromptModal');
                              promptModal.classList.remove('hidden');
                              document.getElementById('cancelAll').onclick = async () => {
                                await cancelAppointment(date, currentSlot.name_lastname, duration, currentSlot);
                                promptModal.classList.add('hidden');
                                modal.classList.add('hidden');
                                await loadWeek(startDate);
                              };
                              document.getElementById('cancelSingle').onclick = async () => {
                                await cancelSingleSlot(date, time, currentSlot);
                                promptModal.classList.add('hidden');
                                modal.classList.add('hidden');
                                await loadWeek(startDate);
                              };
                              document.getElementById('closePrompt').onclick = () => {
                                promptModal.classList.add('hidden');
                              };
                              return;
                            }
                          }
                        }
                        await cancelAppointment(date, currentSlot.name_lastname, duration, currentSlot);
                        modal.classList.add('hidden');
                        await loadWeek(startDate);
                      } catch (err) {
                        console.error('Unexpected cancel error:', err);
                        document.getElementById('message').textContent = 'Neočekivana greška pri otkazivanju.';
                        document.getElementById('message').classList.add('text-red-600');
                      }
                    };

                    completeButton.onclick = async () => {
                      if (currentSlot.is_completed) return;
                      const completeModal = document.getElementById('completeModal');
                      const amountInput = document.getElementById('amountCharged');
                      amountInput.value = '';
                      completeModal.classList.remove('hidden');

                      document.getElementById('submitComplete').onclick = async () => {
                        const amount = parseFloat(amountInput.value);
                        if (isNaN(amount) || amount <= 0) {
                          document.getElementById('message').textContent = 'Unesite važeći iznos veći od 0.';
                          document.getElementById('message').classList.add('text-red-600');
                          completeModal.classList.add('hidden');
                          return;
                        }
                        showLoading();
                        try {
                          const duration = currentSlot.duration || 30;
                          const slotCount = Math.ceil(duration / 30);
                          const { data: appointmentSlots, error: fetchError } = await supabaseClient
                            .from(APPOINTMENTS_TABLE)
                            .select('time, name_lastname, phone, main_service, sub_service, length, shape, design, notes, duration, date')
                            .eq('date', date)
                            .eq('name_lastname', currentSlot.name_lastname)
                            .eq('duration', duration)
                            .eq('is_booked', true)
                            .order('time', { ascending: true });
                          if (fetchError) {
                            console.error('Fetch appointment slots error:', fetchError);
                            document.getElementById('message').textContent = `Greška pri dohvatanju termina: ${fetchError.message}`;
                            document.getElementById('message').classList.add('text-red-600');
                            return;
                          }
                          const times = appointmentSlots.map(s => s.time);
                          const { data: slotCheck, error: checkError } = await supabaseClient
                            .from(APPOINTMENTS_TABLE)
                            .select('time, is_booked, is_completed')
                            .eq('date', date)
                            .in('time', times);
                          if (checkError) {
                            console.error('Slot check error:', checkError);
                            document.getElementById('message').textContent = `Greška pri proveri termina: ${checkError.message}`;
                            document.getElementById('message').classList.add('text-red-600');
                            return;
                          }
                          const invalidSlots = slotCheck.filter(s => !s.is_booked || s.is_completed);
                          if (invalidSlots.length > 0) {
                            document.getElementById('message').textContent = 'Termin je već završen ili otkazan.';
                            document.getElementById('message').classList.add('text-red-600');
                            return;
                          }

                          const firstSlot = appointmentSlots[0];
                          const { error: insertError } = await supabaseClient
                            .from(COMPLETED_TABLE)
                            .insert({
                              name_lastname: firstSlot.name_lastname,
                              phone: firstSlot.phone,
                              main_service: firstSlot.main_service,
                              sub_service: firstSlot.sub_service,
                              length: firstSlot.length,
                              shape: firstSlot.shape,
                              design: firstSlot.design,
                              notes: firstSlot.notes,
                              duration: firstSlot.duration,
                              date: firstSlot.date,
                              start_time: firstSlot.time,
                              amount_charged: amount
                            });
                          if (insertError) {
                            console.error('Insert completed appointment error:', insertError);
                            document.getElementById('message').textContent = `Greška pri čuvanju završenog termina: ${insertError.message}`;
                            document.getElementById('message').classList.add('text-red-600');
                            return;
                          }

                          const { error: updateError } = await supabaseClient
                            .from(APPOINTMENTS_TABLE)
                            .update({
                              is_completed: true,
                              amount_charged: amount
                            })
                            .eq('date', date)
                            .in('time', times);
                          if (updateError) {
                            console.error('Update completed slots error:', updateError);
                            document.getElementById('message').textContent = `Greška pri ažuriranju termina: ${updateError.message}`;
                            document.getElementById('message').classList.add('text-red-600');
                            return;
                          }

                          document.getElementById('message').textContent = 'Termin uspešno završen.';
                          document.getElementById('message').classList.add('text-green-600');
                          document.getElementById('message').classList.remove('text-red-600');
                          completeModal.classList.add('hidden');
                          modal.classList.add('hidden');
                          await loadWeek(startDate);
                        } finally {
                          hideLoading();
                        }
                      };

                      document.getElementById('cancelComplete').onclick = () => {
                        completeModal.classList.add('hidden');
                      };
                    };
                  } else {
                    const newAvailable = !currentSlot.available;
                    console.log('Updating slot:', { date, time, newAvailable });
                    const { error } = await supabaseClient
                      .from(APPOINTMENTS_TABLE)
                      .update({ available: newAvailable })
                      .eq('date', date)
                      .eq('time', `${time}:00`);
                    if (error) {
                      console.error('Update error:', error);
                      document.getElementById('message').textContent = `Greška pri ažuriranju: ${error.message}`;
                      document.getElementById('message').classList.add('text-red-600');
                    } else {
                      td.classList.toggle('slot-available', newAvailable && !currentSlot.is_booked && !currentSlot.is_completed);
                      td.classList.toggle('slot-unavailable', !newAvailable);
                      td.innerHTML = currentSlot.is_booked ? `${currentSlot.name_lastname || ''}<br>${currentSlot.main_service || ''}` : newAvailable ? 'Slobodno' : 'Zatvoreno';
                      console.log('Slot updated successfully:', { date, time, available: newAvailable });
                      await loadWeek(startDate);
                    }
                  }
                } finally {
                  hideLoading();
                }
              };

              td.addEventListener('click', handleSlotInteraction);
              td.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                touchStartTime = Date.now();
                isScrolling = false;
              });
              td.addEventListener('touchmove', (e) => {
                const touchX = e.touches[0].clientX;
                const touchY = e.touches[0].clientY;
                const deltaX = Math.abs(touchX - touchStartX);
                const deltaY = Math.abs(touchY - touchStartY);
                if (deltaX > 10 || deltaY > 10) {
                  isScrolling = true;
                }
              });
              td.addEventListener('touchend', (e) => {
                const touchDuration = Date.now() - touchStartTime;
                if (!isScrolling && touchDuration < 500) {
                  handleSlotInteraction(e);
                }
              });

              row.appendChild(td);
            });
            slotsTable.appendChild(row);
          });
        } finally {
          hideLoading();
        }
      }

      async function cancelAppointment(date, name_lastname, duration, slotData) {
        showLoading();
        try {
          const { data: appointmentSlots, error: fetchError } = await supabaseClient
            .from(APPOINTMENTS_TABLE)
            .select('time, name_lastname, phone, main_service, sub_service, length, shape, design, notes, duration, date')
            .eq('date', date)
            .eq('name_lastname', name_lastname)
            .eq('duration', duration)
            .eq('is_booked', true)
            .order('time', { ascending: true });
          if (fetchError) {
            console.error('Fetch appointment slots error:', fetchError);
            document.getElementById('message').textContent = `Greška pri dohvatanju termina: ${fetchError.message}`;
            document.getElementById('message').classList.add('text-red-600');
            return;
          }
          const times = appointmentSlots.map(slot => slot.time);
          console.log('Canceling appointment:', { date, name_lastname, duration, times });

          const { data: slotCheck, error: checkError } = await supabaseClient
            .from(APPOINTMENTS_TABLE)
            .select('time, is_booked, is_completed')
            .eq('date', date)
            .in('time', times);
          if (checkError) {
            console.error('Slot check error:', checkError);
            document.getElementById('message').textContent = `Greška pri proveri termina: ${checkError.message}`;
            document.getElementById('message').classList.add('text-red-600');
            return;
          }
          const unbookedOrCompletedSlots = slotCheck.filter(slot => !slot.is_booked || slot.is_completed);
          if (unbookedOrCompletedSlots.length > 0) {
            document.getElementById('message').textContent = 'Termin je već otkazan, završen ili izmenjen.';
            document.getElementById('message').classList.add('text-red-600');
            return;
          }

          if (appointmentSlots.length > 0) {
            const firstSlot = appointmentSlots[0];
            console.log('Attempting to save canceled appointment:', firstSlot);
            const { error: insertError } = await supabaseClient
              .from(CANCELED_TABLE)
              .insert({
                name_lastname: firstSlot.name_lastname,
                phone: firstSlot.phone,
                main_service: firstSlot.main_service,
                sub_service: firstSlot.sub_service,
                length: firstSlot.length,
                shape: firstSlot.shape,
                design: firstSlot.design,
                notes: firstSlot.notes,
                duration: firstSlot.duration,
                date: firstSlot.date,
                start_time: firstSlot.time
              });
            if (insertError) {
              console.error('Insert canceled appointment error:', insertError);
              document.getElementById('message').textContent = `Greška pri čuvanju otkazanog termina: ${insertError.message}`;
              document.getElementById('message').classList.add('text-red-600');
            } else {
              console.log('Saved canceled appointment:', { date, start_time: firstSlot.time });
            }
          }

          const { error } = await supabaseClient
            .from(APPOINTMENTS_TABLE)
            .update({
              is_booked: false,
              available: true,
              name_lastname: null,
              phone: null,
              main_service: null,
              sub_service: null,
              length: null,
              shape: null,
              design: null,
              notes: null,
              duration: null,
              amount_charged: null
            })
            .eq('date', date)
            .in('time', times);
          if (error) {
            console.error('Cancel appointment error:', error);
            document.getElementById('message').textContent = `Greška pri otkazivanju termina: ${error.message}`;
            document.getElementById('message').classList.add('text-red-600');
          } else {
            console.log('Appointment canceled:', { date, times });
            document.getElementById('message').textContent = 'Termin uspešno otkazan.';
            document.getElementById('message').classList.add('text-green-600');
            document.getElementById('message').classList.remove('text-red-600');
          }
        } finally {
          hideLoading();
        }
      }

      async function cancelSingleSlot(date, time, slotData) {
        showLoading();
        try {
          const { data: slotCheck, error: checkError } = await supabaseClient
            .from(APPOINTMENTS_TABLE)
            .select('is_booked, is_completed')
            .eq('date', date)
            .eq('time', `${time}:00`)
            .single();
          if (checkError) {
            console.error('Slot check error:', checkError);
            document.getElementById('message').textContent = `Greška pri proveri slota: ${checkError.message}`;
            document.getElementById('message').classList.add('text-red-600');
            return;
          }
          if (!slotCheck.is_booked || slotCheck.is_completed) {
            document.getElementById('message').textContent = 'Slot je već otkazan, završen ili izmenjen.';
            document.getElementById('message').classList.add('text-red-600');
            return;
          }

          console.log('Attempting to save canceled slot:', slotData);
          const { error: insertError } = await supabaseClient
            .from(CANCELED_TABLE)
            .insert({
              name_lastname: slotData.name_lastname,
              phone: slotData.phone,
              main_service: slotData.main_service,
              sub_service: slotData.sub_service,
              length: slotData.length,
              shape: slotData.shape,
              design: slotData.design,
              notes: slotData.notes,
              duration: slotData.duration,
              date: slotData.date,
              start_time: slotData.time
            });
          if (insertError) {
            console.error('Insert canceled slot error:', insertError);
            document.getElementById('message').textContent = `Greška pri čuvanju otkazanog slota: ${insertError.message}`;
            document.getElementById('message').classList.add('text-red-600');
          } else {
            console.log('Saved canceled slot:', { date, time });
          }

          const { error } = await supabaseClient
            .from(APPOINTMENTS_TABLE)
            .update({
              is_booked: false,
              available: true,
              name_lastname: null,
              phone: null,
              main_service: null,
              sub_service: null,
              length: null,
              shape: null,
              design: null,
              notes: null,
              duration: null,
              amount_charged: null
            })
            .eq('date', date)
            .eq('time', `${time}:00`);
          if (error) {
            console.error('Cancel single slot error:', error);
            document.getElementById('message').textContent = `Greška pri otkazivanju slota: ${error.message}`;
            document.getElementById('message').classList.add('text-red-600');
          } else {
            console.log('Single slot canceled:', { date, time });
            document.getElementById('message').textContent = 'Slot uspešno otkazan.';
            document.getElementById('message').classList.add('text-green-600');
            document.getElementById('message').classList.remove('text-red-600');
          }
        } finally {
          hideLoading();
        }
      }

      async function loadCancellationHistory() {
        showLoading();
        try {
          const { data, error } = await supabaseClient
            .from(CANCELED_TABLE)
            .select('name_lastname, phone, main_service, date, start_time, canceled_at')
            .order('canceled_at', { ascending: false })
            .limit(15);
          if (error) {
            console.error('Fetch cancellation history error:', error);
            document.getElementById('message').textContent = `Greška pri učitavanju istorije: ${error.message}`;
            document.getElementById('message').classList.add('text-red-600');
            return;
          }
          const historyTable = document.getElementById('historyTable');
          historyTable.innerHTML = '';
          if (data.length === 0) {
            historyTable.innerHTML = '<tr><td colspan="6" class="border p-2 text-center">Nema otkazanih termina.</td></tr>';
            return;
          }
          data.forEach(record => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td class="border p-2 text-xs sm:text-sm">${record.name_lastname || '-'}</td>
              <td class="border p-2 text-xs sm:text-sm">${record.phone || '-'}</td>
              <td class="border p-2 text-xs sm:text-sm">${record.main_service || '-'}</td>
              <td class="border p-2 text-xs sm:text-sm">${new Date(record.date).toLocaleDateString('sr-RS')}</td>
              <td class="border p-2 text-xs sm:text-sm">${record.start_time.slice(0, 5)}</td>
              <td class="border p-2 text-xs sm:text-sm">${new Date(record.canceled_at).toLocaleString('sr-RS')}</td>
            `;
            historyTable.appendChild(row);
          });
        } finally {
          hideLoading();
        }
      }

      async function loadCompletedHistory() {
        showLoading();
        try {
          const { data, error } = await supabaseClient
            .from(COMPLETED_TABLE)
            .select('name_lastname, main_service, date, start_time, amount_charged, completed_at')
            .order('completed_at', { ascending: false });
          if (error) {
            console.error('Fetch completed history error:', error);
            document.getElementById('message').textContent = `Greška pri učitavanju istorije završenih termina: ${error.message}`;
            document.getElementById('message').classList.add('text-red-600');
            return;
          }
          const historyTable = document.getElementById('completedHistoryTable');
          historyTable.innerHTML = '';
          if (data.length === 0) {
            historyTable.innerHTML = '<tr><td colspan="6" class="border p-2 text-center">Nema završenih termina.</td></tr>';
            document.getElementById('totalAmount').textContent = '0,00';
            document.getElementById('monthlyAmount').textContent = '0,00';
            return;
          }
          const total = data.reduce((sum, record) => sum + (record.amount_charged || 0), 0);
          const currentMonth = new Date('2025-05-01').getMonth();
          const monthlyTotal = data
            .filter(record => new Date(record.date).getMonth() === currentMonth)
            .reduce((sum, record) => sum + (record.amount_charged || 0), 0);
          data.forEach(record => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td class="border p-2 text-xs sm:text-sm">${record.name_lastname || '-'}</td>
              <td class="border p-2 text-xs sm:text-sm">${record.main_service || '-'}</td>
              <td class="border p-2 text-xs sm:text-sm">${new Date(record.date).toLocaleDateString('sr-RS')}</td>
              <td class="border p-2 text-xs sm:text-sm">${record.start_time.slice(0, 5)}</td>
              <td class="border p-2 text-xs sm:text-sm">${formatCurrency(record.amount_charged || 0)}</td>
              <td class="border p-2 text-xs sm:text-sm">${new Date(record.completed_at).toLocaleString('sr-RS')}</td>
            `;
            historyTable.appendChild(row);
          });
          document.getElementById('totalAmount').textContent = formatCurrency(total).replace(' RSD', '');
          document.getElementById('monthlyAmount').textContent = formatCurrency(monthlyTotal).replace(' RSD', '');
        } finally {
          hideLoading();
        }
      }

      document.getElementById('closeModal').onclick = () => {
        document.getElementById('bookingModal').classList.add('hidden');
      };
      document.getElementById('bookingModal').onclick = (e) => {
        if (e.target === document.getElementById('bookingModal')) {
          document.getElementById('bookingModal').classList.add('hidden');
        }
      };
      document.getElementById('closePrompt').onclick = () => {
        document.getElementById('cancelPromptModal').classList.add('hidden');
      };
      document.getElementById('cancelPromptModal').onclick = (e) => {
        if (e.target === document.getElementById('cancelPromptModal')) {
          document.getElementById('cancelPromptModal').classList.add('hidden');
        }
      };
      document.getElementById('completeModal').onclick = (e) => {
        if (e.target === document.getElementById('completeModal')) {
          document.getElementById('completeModal').classList.add('hidden');
        }
      };
      document.getElementById('historyButton').addEventListener('click', async () => {
        const modal = document.getElementById('historyModal');
        await loadCancellationHistory();
        modal.classList.remove('hidden');
      });
      document.getElementById('closeHistoryModal').addEventListener('click', () => {
        document.getElementById('historyModal').classList.add('hidden');
      });
      document.getElementById('historyModal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('historyModal')) {
          document.getElementById('historyModal').classList.add('hidden');
        }
      });
      document.getElementById('completedHistoryButton').addEventListener('click', async () => {
        const modal = document.getElementById('completedHistoryModal');
        await loadCompletedHistory();
        modal.classList.remove('hidden');
      });
      document.getElementById('closeCompletedHistoryModal').addEventListener('click', () => {
        document.getElementById('completedHistoryModal').classList.add('hidden');
      });
      document.getElementById('completedHistoryModal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('completedHistoryModal')) {
          document.getElementById('completedHistoryModal').classList.add('hidden');
        }
      });

      document.getElementById('prevWeek').addEventListener('click', async () => {
        currentWeekStart.setDate(currentWeekStart.getDate() - 7);
        await initializeSlots(currentWeekStart);
        await loadWeek(currentWeekStart);
      });

      document.getElementById('nextWeek').addEventListener('click', async () => {
        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
        await initializeSlots(currentWeekStart);
        await loadWeek(currentWeekStart);
      });

      await initializeSlots(currentWeekStart);
      await loadWeek(currentWeekStart);
    };
  </script>
</body>
</html>
