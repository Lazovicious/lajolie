<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin: Manage Available Time Slots</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 1em auto;
      padding: 0 1em;
    }
    h1 {
      text-align: center;
    }
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-top: 20px;
    }
    .day-name {
      font-weight: bold;
      text-align: center;
      padding: 8px 0;
      background: #f0f0f0;
      border-radius: 4px;
    }
    .date-cell {
      border: 1px solid #ddd;
      padding: 6px;
      cursor: pointer;
      user-select: none;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      border-radius: 6px;
      background: white;
      transition: background-color 0.3s ease;
    }
    .date-cell.today {
      border-color: #2a9d8f;
      box-shadow: 0 0 5px #2a9d8f;
    }
    .date-cell.disabled {
      background: #eee;
      color: #999;
      cursor: default;
    }
    .date-cell.available {
      background: #90ee90; /* lightgreen */
    }
    .date-cell.occupied {
      background: #e57373; /* light red */
      cursor: not-allowed;
    }
    .slot-list {
      margin-top: 4px;
      font-size: 0.8em;
      width: 100%;
    }
    .slot {
      padding: 2px 4px;
      border-radius: 3px;
      margin-bottom: 2px;
      background: #ccc;
      text-align: center;
    }
    .slot.available {
      background: #2a9d8f;
      color: white;
      cursor: pointer;
    }
    .slot.occupied {
      background: #c62828;
      color: white;
      cursor: not-allowed;
    }
    #status {
      margin-top: 20px;
      font-weight: bold;
      text-align: center;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>Admin: Manage Available Time Slots</h1>

  <div id="status">Loading...</div>
  <div id="calendar"></div>

  <!-- Load Supabase JS v2 (latest stable) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.33.1/dist/supabase.min.js"></script>

  <script>
    (async () => {
      // --- Config ---
      const SUPABASE_URL = 'https://xkljqcxonrnstuivtihc.supabase.co';
      const SUPABASE_ANON_KEY = prompt('Enter Supabase anon key for admin:');
      if (!SUPABASE_ANON_KEY) {
        alert('Admin key is required. Reload page to try again.');
        return;
      }

      // Initialize Supabase client (global 'supabase' available from CDN)
      const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const AVAILABILITY_TABLE = 'availability_slots';
      const BOOKINGS_TABLE = 'jolie_t1';

      // Constants for calendar display
      const DAY_NAMES_SR = ['PON', 'UTO', 'SRE', 'ČET', 'PET', 'SUB', 'NED'];

      // Date/time helpers
      function formatDateISO(date) {
        return date.toISOString().slice(0, 10);
      }

      // Generate 30-min slots from 08:00 to 20:00
      function generateDailySlots() {
        const slots = [];
        for (let h = 8; h <= 19; h++) {
          slots.push(`${h.toString().padStart(2, '0')}:00`);
          slots.push(`${h.toString().padStart(2, '0')}:30`);
        }
        slots.push('20:00'); // last slot end
        return slots;
      }

      // Fetch availability slots from Supabase for a range of dates
      async function fetchAvailability(startDate, endDate) {
        const { data, error } = await supabase
          .from(AVAILABILITY_TABLE)
          .select('*')
          .gte('date', startDate)
          .lte('date', endDate);

        if (error) {
          console.error('Error fetching availability:', error);
          return [];
        }
        return data;
      }

      // Fetch booked slots from bookings table for date range
      async function fetchBookedSlots(startDate, endDate) {
        const { data, error } = await supabase
          .from(BOOKINGS_TABLE)
          .select('date,time')
          .gte('date', startDate)
          .lte('date', endDate);

        if (error) {
          console.error('Error fetching booked slots:', error);
          return [];
        }
        return data;
      }

      // Insert or delete availability slot on toggle
      async function toggleAvailability(date, time, currentlyAvailable) {
        if (currentlyAvailable) {
          // Delete slot
          const { error } = await supabase
            .from(AVAILABILITY_TABLE)
            .delete()
            .eq('date', date)
            .eq('time', time);

          if (error) {
            alert('Error deleting slot: ' + error.message);
          } else {
            console.log(`Deleted availability slot: ${date} ${time}`);
          }
          return !currentlyAvailable;
        } else {
          // Insert slot
          const { error } = await supabase
            .from(AVAILABILITY_TABLE)
            .insert([{ date, time, available: true }]);

          if (error) {
            alert('Error adding slot: ' + error.message);
          } else {
            console.log(`Added availability slot: ${date} ${time}`);
          }
          return !currentlyAvailable;
        }
      }

      // Render the calendar UI with days and slots
      async function renderCalendar(monthDate) {
        const calendarEl = document.getElementById('calendar');
        calendarEl.innerHTML = '';

        // Show day names
        for (let i = 0; i < 7; i++) {
          const dayNameEl = document.createElement('div');
          dayNameEl.className = 'day-name';
          dayNameEl.textContent = DAY_NAMES_SR[i];
          calendarEl.appendChild(dayNameEl);
        }

        // Compute first day of month and number of days
        const year = monthDate.getFullYear();
        const month = monthDate.getMonth();

        const firstOfMonth = new Date(year, month, 1);
        const firstWeekDay = (firstOfMonth.getDay() + 6) % 7; // Convert Sunday=0 to Serbian Monday=0

        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Date range for fetching availability/bookings
        const startDate = formatDateISO(firstOfMonth);
        const lastOfMonth = new Date(year, month, daysInMonth);
        const endDate = formatDateISO(lastOfMonth);

        // Fetch availability and bookings for entire month
        const availabilitySlots = await fetchAvailability(startDate, endDate);
        const bookedSlots = await fetchBookedSlots(startDate, endDate);

        // Create empty slots map for quick lookup
        const availabilityMap = new Map(); // key: 'YYYY-MM-DD|HH:MM' -> true
        for (const slot of availabilitySlots) {
          availabilityMap.set(`${slot.date}|${slot.time}`, slot.available);
        }

        const bookedMap = new Map(); // key: 'YYYY-MM-DD|HH:MM' -> true
        for (const b of bookedSlots) {
          bookedMap.set(`${b.date}|${b.time}`, true);
        }

        // Add empty cells before first day
        for (let i = 0; i < firstWeekDay; i++) {
          const emptyCell = document.createElement('div');
          emptyCell.className = 'date-cell disabled';
          calendarEl.appendChild(emptyCell);
        }

        // Generate slots array for each day
        const daySlots = generateDailySlots();

        // For each day in month, create a cell
        for (let day = 1; day <= daysInMonth; day++) {
          const dateObj = new Date(year, month, day);
          const isoDate = formatDateISO(dateObj);

          const dayCell = document.createElement('div');
          dayCell.className = 'date-cell';
          if (isoDate === formatDateISO(new Date())) {
            dayCell.classList.add('today');
          }

          // Add date number
          const dateLabel = document.createElement('div');
          dateLabel.textContent = day;
          dayCell.appendChild(dateLabel);

          // Slot container
          const slotList = document.createElement('div');
          slotList.className = 'slot-list';

          // Add slots
          for (let i = 0; i < daySlots.length - 1; i++) {
            // e.g. '08:00', next slot '08:30'
            const slotStart = daySlots[i];
            // Check if booked
            const isBooked = bookedMap.has(`${isoDate}|${slotStart}`);
            // Check if available
            const isAvailable = availabilityMap.get(`${isoDate}|${slotStart}`) === true;

            const slotEl = document.createElement('div');
            slotEl.classList.add('slot');
            slotEl.textContent = slotStart;

            if (isBooked) {
              slotEl.classList.add('occupied');
              slotEl.title = 'Zakazano';
            } else if (isAvailable) {
              slotEl.classList.add('available');
              slotEl.title = 'Dostupno - klik za uklanjanje';
              // Click to remove availability
              slotEl.addEventListener('click', async () => {
                slotEl.textContent = '...';
                const success = await toggleAvailability(isoDate, slotStart, true);
                if (success === false) {
                  alert('Greška pri uklanjanju dostupnog termina.');
                } else {
                  slotEl.classList.remove('available');
                  slotEl.textContent = slotStart;
                }
              });
            } else {
              slotEl.title = 'Klik za dodavanje dostupnog termina';
              // Click to add availability
              slotEl.addEventListener('click', async () => {
                slotEl.textContent = '...';
                const success = await toggleAvailability(isoDate, slotStart, false);
                if (success === false) {
                  alert('Greška pri dodavanju dostupnog termina.');
                } else {
                  slotEl.classList.add('available');
                  slotEl.textContent = slotStart;
                }
              });
            }

            slotList.appendChild(slotEl);
          }

          dayCell.appendChild(slotList);
          calendarEl.appendChild(dayCell);
        }

        // Update status
        document.getElementById('status').textContent = `Prikaz kalendara za ${year}-${(month+1).toString().padStart(2,'0')}`;
      }

      // Kickoff
      try {
        const today = new Date();
        await renderCalendar(today);
      } catch (err) {
        console.error('Fatal error rendering calendar:', err);
        document.getElementById('status').textContent = 'Greška pri učitavanju kalendara.';
      }
    })();
  </script>
</body>
</html>
