<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Manage Availability</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-top: 20px;
    }

    .day-header {
      font-weight: bold;
      text-align: center;
      margin-bottom: 8px;
    }

    .day-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1px solid #ccc;
      padding: 8px;
      min-height: 300px;
    }

    .slot {
      width: 100%;
      margin: 2px 0;
      padding: 4px;
      text-align: center;
      border-radius: 4px;
      cursor: pointer;
      background-color: #f0f0f0;
    }

    .available {
      background-color: #b0f2b6;
    }

    .booked {
      background-color: #f5a9a9;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Admin: Manage Available Time Slots</h1>
  <div id="calendar"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.6/dist/supabase.umd.min.js"></script>
  <script>
    (async () => {
      const SUPABASE_URL = 'https://xkljqcxonrnstuivtihc.supabase.co';
      const SUPABASE_ANON_KEY = prompt('Enter Supabase anon key for admin:');

      if (!SUPABASE_ANON_KEY) {
        alert('Admin key is required. Reload page to try again.');
        return;
      }

      const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const AVAILABILITY_TABLE = 'availability_slots';
      const BOOKINGS_TABLE = 'jolie_t1';

      const dayLabels = ['Ponedeljak', 'Utorak', 'Sreda', 'Četvrtak', 'Petak', 'Subota', 'Nedelja'];

      const generateSlotsForWeek = (startDate) => {
        const slots = [];
        for (let dayOffset = 0; dayOffset < 7; dayOffset++) {
          const day = new Date(startDate);
          day.setDate(day.getDate() + dayOffset);

          const dateStr = day.toISOString().split('T')[0];
          for (let hour = 9; hour < 20; hour++) {
            for (let min of [0, 30]) {
              const timeStr = `${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
              slots.push({ date: dateStr, time: timeStr });
            }
          }
        }
        return slots;
      };

      const startOfWeek = new Date();
      startOfWeek.setDate(startOfWeek.getDate() - ((startOfWeek.getDay() + 6) % 7)); // Set to Monday

      const allSlots = generateSlotsForWeek(startOfWeek);

      const { data: booked, error: bookedError } = await supabaseClient
        .from(BOOKINGS_TABLE)
        .select('date,time');

      const { data: available, error: availableError } = await supabaseClient
        .from(AVAILABILITY_TABLE)
        .select('date,time,is_available');

      const calendar = document.getElementById('calendar');
      dayLabels.forEach(label => {
        const header = document.createElement('div');
        header.className = 'day-header';
        header.textContent = label;
        calendar.appendChild(header);
      });

      for (let dayOffset = 0; dayOffset < 7; dayOffset++) {
        const column = document.createElement('div');
        column.className = 'day-column';

        const currentDate = new Date(startOfWeek);
        currentDate.setDate(currentDate.getDate() + dayOffset);
        const dateStr = currentDate.toISOString().split('T')[0];

        const slotsForDay = allSlots.filter(slot => slot.date === dateStr);
        slotsForDay.forEach(slot => {
          const slotDiv = document.createElement('div');
          slotDiv.className = 'slot';
          slotDiv.textContent = slot.time;
          slotDiv.dataset.date = slot.date;
          slotDiv.dataset.time = slot.time;

          const isBooked = booked?.some(b => b.date === slot.date && b.time === slot.time);
          const isAvailable = available?.some(a => a.date === slot.date && a.time === slot.time && a.is_available);

          if (isBooked) {
            slotDiv.classList.add('booked');
          } else if (isAvailable) {
            slotDiv.classList.add('available');
          }

          slotDiv.addEventListener('click', async () => {
            if (slotDiv.classList.contains('booked')) return;

            const currentlyAvailable = slotDiv.classList.contains('available');
            slotDiv.classList.toggle('available');

            const { error } = await supabaseClient
              .from(AVAILABILITY_TABLE)
              .upsert({
                date: slot.date,
                time: slot.time,
                is_available: !currentlyAvailable
              }, { onConflict: ['date', 'time'] });

            if (error) {
              alert('Greška prilikom ažuriranja termina!');
              console.error(error);
            }
          });

          column.appendChild(slotDiv);
        });

        calendar.appendChild(column);
      }
    })();
  </script>
</body>
</html>
